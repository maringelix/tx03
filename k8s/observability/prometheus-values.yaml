# kube-prometheus-stack Configuration for GCP GKE
# Optimized for DX03 application monitoring on Google Cloud

# Prometheus Configuration
prometheus:
  prometheusSpec:
    # Data retention
    retention: 7d
    retentionSize: 5GB
    
    # Storage - using GCP persistent disk
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: standard-rwo  # GKE default storage class
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 10Gi
    
    # Resource limits - optimized for GKE Autopilot
    resources:
      requests:
        memory: 512Mi
        cpu: 200m
      limits:
        memory: 2Gi
        cpu: 1000m
    
    # Scrape configuration
    scrapeInterval: 30s
    evaluationInterval: 30s
    
    # Replicas for HA
    replicas: 1
    
    # Service monitors
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    
    # Additional scrape configs for DX03
    additionalScrapeConfigs:
    - job_name: 'dx03-frontend'
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
          - dx03-dev
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_app]
        action: keep
        regex: dx03-frontend
      - source_labels: [__meta_kubernetes_pod_ip]
        target_label: __address__
        replacement: '$1:80'
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: pod
      - source_labels: [__meta_kubernetes_namespace]
        target_label: namespace
    
    - job_name: 'dx03-backend'
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
          - dx03-dev
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_app]
        action: keep
        regex: dx03-backend
      - source_labels: [__meta_kubernetes_pod_ip]
        target_label: __address__
        replacement: '$1:3000'
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: pod
      - source_labels: [__meta_kubernetes_namespace]
        target_label: namespace

# Grafana Configuration
grafana:
  enabled: true
  
  # Admin credentials (will be overridden by workflow secret)
  adminPassword: admin
  
  # Disable sidecar that creates duplicate datasources
  sidecar:
    datasources:
      enabled: false
    dashboards:
      enabled: true
      label: grafana_dashboard
      labelValue: "1"
  
  # Persistence for dashboards and settings
  persistence:
    enabled: true
    storageClassName: standard-rwo
    size: 5Gi
  
  # Service configuration
  service:
    type: ClusterIP  # Use port-forward or ingress
    port: 80
  
  # Resources - optimized for GKE
  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi
      cpu: 300m
  
  # Data sources
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
      - name: Prometheus
        type: prometheus
        url: http://kube-prometheus-stack-prometheus:9090
        access: proxy
        isDefault: true
        jsonData:
          timeInterval: 30s
      - name: Google Cloud Monitoring
        type: stackdriver
        access: proxy
        jsonData:
          authenticationType: gce
          defaultProject: project-28e61e96-b6ac-4249-a21
  
  # Grafana plugins
  plugins:
    - grafana-piechart-panel
    - grafana-clock-panel
    - grafana-simple-json-datasource
  
  # Dashboard providers
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards/default
  
  # Custom Grafana configuration
  grafana.ini:
    server:
      root_url: "%(protocol)s://%(domain)s/"
      serve_from_sub_path: false
    analytics:
      check_for_updates: true
    security:
      allow_embedding: true
    auth.anonymous:
      enabled: false

# Alertmanager Configuration
alertmanager:
  alertmanagerSpec:
    # Storage
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: standard-rwo
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 2Gi
    
    # Resources
    resources:
      requests:
        memory: 128Mi
        cpu: 50m
      limits:
        memory: 256Mi
        cpu: 200m
    
    # Replicas
    replicas: 1

# Prometheus Operator Configuration
prometheusOperator:
  resources:
    requests:
      memory: 128Mi
      cpu: 50m
    limits:
      memory: 256Mi
      cpu: 200m

# Node Exporter - monitor GKE nodes
nodeExporter:
  enabled: true
  resources:
    requests:
      memory: 64Mi
      cpu: 50m
    limits:
      memory: 128Mi
      cpu: 100m

# Kube State Metrics - K8s resource metrics
kubeStateMetrics:
  enabled: true
  resources:
    requests:
      memory: 128Mi
      cpu: 50m
    limits:
      memory: 256Mi
      cpu: 200m

# Default rules (alerts)
defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: false  # Not applicable in GKE
    configReloaders: true
    general: true
    k8s: true
    kubeApiserverAvailability: true
    kubeApiserverSlos: false  # Disable to reduce noise
    kubelet: true
    kubeProxy: false  # Not applicable in GKE Autopilot
    kubeScheduler: false  # Not applicable in GKE
    kubernetesApps: true
    kubernetesResources: true
    kubernetesStorage: true
    kubernetesSystem: true
    node: true
    nodeExporterAlerting: true
    nodeExporterRecording: true
    prometheus: true
    prometheusOperator: true

# Global labels
commonLabels:
  environment: dev
  cluster: tx03-gke-cluster
  project: dx03
