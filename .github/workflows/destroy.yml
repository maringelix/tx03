name: ðŸ—‘ï¸ Destroy Infrastructure

on:
  push:
    branches: [master, main]
    paths:
      - '.github/workflows/destroy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to destroy'
        required: true
        type: choice
        options:
          - dev
          - prod
      confirm_destroy:
        description: 'Type "destroy" to confirm'
        required: true
        type: string
      destroy_backend:
        description: 'Also destroy Terraform backend (GCS bucket)?'
        required: true
        type: boolean
        default: false

permissions:
  contents: read
  id-token: write

jobs:
  validate:
    name: Validate Destroy Request
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "destroy" ]; then
            echo "âŒ Destroy confirmation failed!"
            echo "You must type 'destroy' to confirm destruction."
            exit 1
          fi
          echo "âœ… Destroy confirmed by @${{ github.actor }}"

      - name: Environment check
        run: |
          echo "âš ï¸  WARNING: About to destroy ${{ github.event.inputs.environment }} environment!"
          echo ""
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Backend will be destroyed: ${{ github.event.inputs.destroy_backend }}"
          echo "Initiated by: @${{ github.actor }}"
          echo ""
          sleep 5  # Give time to cancel if triggered accidentally

  destroy-infrastructure:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    needs: [validate]
    
    env:
      TF_VERSION: '1.9.0'
      ENVIRONMENT: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: List Current Resources
        run: |
          echo "ðŸ“‹ Current GCP resources..."
          
          # List GKE clusters
          echo "ðŸŽ¯ GKE Clusters:"
          gcloud container clusters list --format="table(name,location,status)" || echo "None"
          
          # List Cloud SQL instances
          echo ""
          echo "ðŸ—„ï¸  Cloud SQL Instances:"
          gcloud sql instances list --format="table(name,region,databaseVersion,state)" || echo "None"
          
          # List Load Balancers
          echo ""
          echo "ðŸŒ Load Balancers:"
          gcloud compute forwarding-rules list --format="table(name,region,IPAddress)" || echo "None"
          
          # List Artifact Registry repos
          echo ""
          echo "ðŸ“¦ Artifact Registry:"
          gcloud artifacts repositories list --format="table(name,location,format)" || echo "None"

      - name: Delete Kubernetes-Managed Resources First
        continue-on-error: true
        run: |
          echo "ðŸ§¹ Deleting Kubernetes-managed resources BEFORE Terraform destroy..."
          
          # Authenticate to GKE cluster
          echo "Connecting to GKE cluster..."
          gcloud container clusters get-credentials tx03-gke-cluster \
            --region=us-central1 \
            --project=${{ secrets.GCP_PROJECT_ID }} || {
            echo "âš ï¸  Could not connect to GKE cluster (may already be deleted)"
            exit 0
          }
          
          # Delete all Ingresses (triggers cleanup of LB, SSL certs, backend services)
          echo "ðŸŒ Deleting all Ingresses..."
          kubectl get ingress --all-namespaces -o json | \
            jq -r '.items[] | "\(.metadata.namespace) \(.metadata.name)"' | \
            while read NS NAME; do
              echo "  Deleting ingress: $NAME in $NS"
              kubectl delete ingress "$NAME" -n "$NS" --wait=true --timeout=5m || true
            done
          
          # Delete all LoadBalancer type Services (triggers cleanup of external LBs)
          echo "âš–ï¸  Deleting all LoadBalancer Services..."
          kubectl get svc --all-namespaces -o json | \
            jq -r '.items[] | select(.spec.type=="LoadBalancer") | "\(.metadata.namespace) \(.metadata.name)"' | \
            while read NS NAME; do
              echo "  Deleting service: $NAME in $NS"
              kubectl delete svc "$NAME" -n "$NS" --wait=true --timeout=5m || true
            done
          
          # Delete all PVCs (triggers cleanup of persistent disks)
          echo "ðŸ’¾ Deleting all PVCs..."
          kubectl get pvc --all-namespaces -o json | \
            jq -r '.items[] | "\(.metadata.namespace) \(.metadata.name)"' | \
            while read NS NAME; do
              echo "  Deleting PVC: $NAME in $NS"
              kubectl delete pvc "$NAME" -n "$NS" --wait=true --timeout=5m || true
            done
          
          # Wait for GKE controllers to clean up cloud resources
          echo "â³ Waiting for GKE to clean up cloud resources (90 seconds)..."
          sleep 90
          
          echo "âœ… Kubernetes resources cleanup initiated"

      - name: Terraform Init
        working-directory: terraform/environments/${{ env.ENVIRONMENT }}
        run: |
          echo "ðŸ”§ Initializing Terraform..."
          terraform init \
            -backend-config="bucket=${{ secrets.GCS_BUCKET }}" \
            -backend-config="prefix=terraform/state/${{ env.ENVIRONMENT }}"

      - name: Terraform Plan Destroy - Review
        working-directory: terraform/environments/${{ env.ENVIRONMENT }}
        run: |
          echo "ðŸ“‹ Generating detailed destroy plan for review..."
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "   TERRAFORM DESTROY PLAN - REVIEW CAREFULLY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          terraform plan -destroy \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="environment=${{ env.ENVIRONMENT }}" \
            -no-color \
            2>&1 | tee destroy_plan_full.txt
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Extract and display summary
          if grep -q "Plan:" destroy_plan_full.txt; then
            echo ""
            echo "ðŸ“Š DESTROY PLAN SUMMARY:"
            grep "Plan:" destroy_plan_full.txt | head -1
            echo ""
            
            # Count resources
            RESOURCES=$(grep -oP 'Plan: \K\d+(?= to destroy)' destroy_plan_full.txt | head -1 || echo "0")
            
            if [ "$RESOURCES" -eq "0" ]; then
              echo "âœ¨ No resources to destroy (infrastructure may already be destroyed)"
              echo ""
              echo "âš ï¸  Will proceed with cleanup steps to ensure no orphaned resources remain."
            else
              echo "ðŸ—‘ï¸  Total resources to be DESTROYED: $RESOURCES"
              echo ""
              echo "âš ï¸  WARNING: The following resources will be PERMANENTLY DELETED:"
              echo ""
              grep "will be destroyed" destroy_plan_full.txt | sed 's/^/  /' || true
              echo ""
              echo "ðŸ’¾ Terraform backend (GCS bucket) will be preserved: ${{ secrets.GCS_BUCKET }}"
              echo "   â†’ Set destroy_backend=true to also delete the state bucket"
            fi
          else
            echo "âš ï¸  Could not parse plan output. Review full log above."
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â³ Proceeding with destroy in 10 seconds..."
          echo "   (Cancel workflow now if plan looks incorrect)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          sleep 10

      - name: Terraform Plan Destroy - Generate Execution Plan
        working-directory: terraform/environments/${{ env.ENVIRONMENT }}
        run: |
          echo "ðŸ“‹ Creating destroy execution plan..."
          terraform plan \
            -destroy \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="environment=${{ env.ENVIRONMENT }}" \
            -out=destroy.tfplan
          
          echo "âœ… Destroy plan created successfully"

      - name: Terraform Destroy
        working-directory: terraform/environments/${{ env.ENVIRONMENT }}
        run: |
          echo "ðŸ—‘ï¸  Destroying infrastructure..."
          terraform apply -auto-approve destroy.tfplan
          echo "âœ… Infrastructure destroyed!"

      - name: Force Cleanup Remaining Resources
        if: always()
        continue-on-error: true
        run: |
          echo "ðŸ§¹ Enhanced force cleanup of remaining resources..."
          
          # 1. Delete any remaining GKE clusters
          echo "ðŸŽ¯ Cleaning up GKE clusters..."
          CLUSTERS=$(gcloud container clusters list --format="value(name)" --filter="name~tx03-" || echo "")
          for CLUSTER in $CLUSTERS; do
            echo "  Deleting cluster: $CLUSTER"
            gcloud container clusters delete "$CLUSTER" --region=us-central1 --quiet || true
          done
          
          # 2. Delete Cloud SQL instances (with protection removal)
          echo "ðŸ—„ï¸  Cleaning up Cloud SQL..."
          SQL_INSTANCES=$(gcloud sql instances list --format="value(name)" --filter="name~tx03-" || echo "")
          for INSTANCE in $SQL_INSTANCES; do
            echo "  Removing deletion protection from: $INSTANCE"
            gcloud sql instances patch "$INSTANCE" --no-deletion-protection --quiet || true
            echo "  Deleting SQL instance: $INSTANCE"
            gcloud sql instances delete "$INSTANCE" --quiet || true
          done
          
          # 3. Delete forwarding rules (Load Balancers)
          echo "ðŸŒ Cleaning up Load Balancer forwarding rules..."
          # Global forwarding rules
          FWD_RULES=$(gcloud compute forwarding-rules list --global --format="value(name)" \
            --filter="name~(tx03|k8s2|k8s-fw)" 2>/dev/null || echo "")
          for RULE in $FWD_RULES; do
            echo "  Deleting global forwarding rule: $RULE"
            gcloud compute forwarding-rules delete "$RULE" --global --quiet || true
          done
          # Regional forwarding rules
          echo ""
          
          # Count remaining resources
          REMAINING_CLUSTERS=$(gcloud container clusters list --filter="name~tx03-" --format="value(name)" 2>/dev/null | wc -l)
          REMAINING_SQL=$(gcloud sql instances list --filter="name~tx03-" --format="value(name)" 2>/dev/null | wc -l)
          REMAINING_FWD_RULES=$(gcloud compute forwarding-rules list --filter="name~(tx03|k8s)" --format="value(name)" 2>/dev/null | wc -l)
          REMAINING_BACKENDS=$(gcloud compute backend-services list --filter="name~(tx03|k8s)" --format="value(name)" 2>/dev/null | wc -l)
          REMAINING_CERTS=$(gcloud compute ssl-certificates list --filter="name~(tx03|mcrt)" --format="value(name)" 2>/dev/null | wc -l)
          REMAINING_DISKS=$(gcloud compute disks list --filter="name~pvc-" --format="value(name)" 2>/dev/null | wc -l)
          REMAINING_FW_RULES=$(gcloud compute firewall-rules list --filter="network~tx03 AND name~k8s" --format="value(name)" 2>/dev/null | wc -l)
          REMAINING_IPS=$(gcloud compute addresses list --filter="name~tx03" --format="value(name)" 2>/dev/null | wc -l)
          
          echo "ðŸ“Š Remaining resources count:"
          echo "  ðŸŽ¯ GKE Clusters: $REMAINING_CLUSTERS"
          echo "  ðŸ—„ï¸  Cloud SQL: $REMAINING_SQL"
          echo "  ðŸŒ Forwarding Rules: $REMAINING_FWD_RULES"
          echo "  ðŸ”™ Backend Services: $REMAINING_BACKENDS"
          echo "  ðŸ”’ SSL Certificates: $REMAINING_CERTS"
          echo "  ðŸ’¾ Orphan Disks: $REMAINING_DISKS"
          echo "  ðŸšª K8s Firewall Rules: $REMAINING_FW_RULES"
          echo "  ðŸŒ Static IPs: $REMAINING_IPS"
          echo ""
          
          TOTAL=$((REMAINING_CLUSTERS + REMAINING_SQL + REMAINING_FWD_RULES + REMAINING_BACKENDS + REMAINING_CERTS + REMAINING_DISKS + REMAINING_FW_RULES + REMAINING_IPS))
          
          if [ "$TOTAL" -eq "0" ]; then
            echo "âœ… All resources destroyed successfully! No orphaned resources found."
          else
            echo "âš ï¸  Warning: $TOTAL resources still remain."
            echo ""
            echo "ðŸ“‹ Details of remaining resources:"
            
            if [ "$REMAINING_CLUSTERS" -gt "0" ]; then
              echo "  GKE Clusters:"
              gcloud container clusters list --filter="name~tx03-" --format="  value(name,location)" 2>/dev/null
            fi
            
            if [ "$REMAINING_SQL" -gt "0" ]; then
              echo "  Cloud SQL:"
              gcloud sql instances list --filter="name~tx03-" --format="  value(name,region)" 2>/dev/null
            fi
            
            if [ "$REMAINING_FWD_RULES" -gt "0" ]; then
              echo "  Forwarding Rules:"
              gcloud compute forwarding-rules list --filter="name~(tx03|k8s)" --format="  value(name,IPAddress)" 2>/dev/null
            fi
            
            if [ "$REMAINING_BACKENDS" -gt "0" ]; then
              echo "  Backend Services:"
              gcloud compute backend-services list --filter="name~(tx03|k8s)" --format="  value(name)" 2>/dev/null
            fi
            
            if [ "$REMAINING_CERTS" -gt "0" ]; then
              echo "  SSL Certificates:"
              gcloud compute ssl-certificates list --filter="name~(tx03|mcrt)" --format="  value(name)" 2>/dev/null
            fi
            
            if [ "$REMAINING_DISKS" -gt "0" ]; then
              echo "  Orphan Disks:"
              gcloud compute disks list --filter="name~pvc-" --format="  value(name,zone,sizeGb)" 2>/dev/null
            fi
            
            if [ "$REMAINING_FW_RULES" -gt "0" ]; then
              echo "  K8s Firewall Rules:"
              gcloud compute firewall-rules list --filter="network~tx03 AND name~k8s" --format="  value(name)" 2>/dev/null
            fi
            
            if [ "$REMAINING_IPS" -gt "0" ]; then
              echo "  Static IPs:"
              gcloud compute addresses list --filter="name~tx03" --format="  value(name,address)" 2>/dev/null
            fi
            
            echo ""
            echo "âš ï¸  Manual cleanup may be required. Check GCP Console for details
            --filter="name~(tx03|k8s2)" 2>/dev/null || echo "")
          for PROXY in $HTTPS_PROXIES; do
            echo "  Deleting HTTPS proxy: $PROXY"
            gcloud compute target-https-proxies delete "$PROXY" --quiet || true
          done
          
          # 5. Delete URL maps
          echo "ðŸ—ºï¸  Cleaning up URL maps..."
          URL_MAPS=$(gcloud compute url-maps list --format="value(name)" \
            --filter="name~(tx03|k8s2)" 2>/dev/null || echo "")
          for MAP in $URL_MAPS; do
            echo "  Deleting URL map: $MAP"
            gcloud compute url-maps delete "$MAP" --quiet || true
          done
          
          # 6. Delete backend services
          echo "ðŸ”™ Cleaning up backend services..."
          BACKENDS=$(gcloud compute backend-services list --format="value(name)" \
            --filter="name~(tx03|k8s1)" 2>/dev/null || echo "")
          for BACKEND in $BACKENDS; do
            echo "  Deleting backend service: $BACKEND"
            gcloud compute backend-services delete "$BACKEND" --global --quiet || true
          done
          
          # 7. Delete SSL certificates
          echo "ðŸ”’ Cleaning up SSL certificates..."
          CERTS=$(gcloud compute ssl-certificates list --format="value(name)" \
            --filter="name~(tx03|mcrt)" 2>/dev/null || echo "")
          for CERT in $CERTS; do
            echo "  Deleting SSL certificate: $CERT"
            gcloud compute ssl-certificates delete "$CERT" --quiet || true
          done
          
          # 8. Delete orphaned persistent disks
          echo "ðŸ’¾ Cleaning up orphaned disks..."
          ORPHAN_DISKS=$(gcloud compute disks list --format="value(name,zone)" \
            --filter="name~pvc- AND -users:*" 2>/dev/null || echo "")
          echo "$ORPHAN_DISKS" | while IFS=$'\t' read -r DISK ZONE; do
            if [ -n "$DISK" ] && [ -n "$ZONE" ]; then
              echo "  Deleting orphaned disk: $DISK in $ZONE"
              gcloud compute disks delete "$DISK" --zone="$ZONE" --quiet || true
            fi
          done
          
          # 9. Delete K8s-created firewall rules
          echo "ðŸšª Cleaning up K8s firewall rules..."
          FW_RULES=$(gcloud compute firewall-rules list --format="value(name)" \
            --filter="network~tx03 AND name~k8s" 2>/dev/null || echo "")
          for RULE in $FW_RULES; do
            echo "  Deleting K8s firewall rule: $RULE"
            gcloud compute firewall-rules delete "$RULE" --quiet || true
          done
          
          # 10. Delete any remaining static IPs
          echo "ðŸŒ Cleaning up static IPs..."
          STATIC_IPS=$(gcloud compute addresses list --format="value(name,region)" \
            --filter="name~tx03 AND status:RESERVED" 2>/dev/null || echo "")
          echo "$STATIC_IPS" | while IFS=$'\t' read -r IP_NAME REGION; do
            if [ -n "$IP_NAME" ]; then
              if [ -n "$REGION" ] && [ "$REGION" != "None" ]; then
                echo "  Deleting regional IP: $IP_NAME in $REGION"
                gcloud compute addresses delete "$IP_NAME" --region="$REGION" --quiet || true
              else
                echo "  Deleting global IP: $IP_NAME"
                gcloud compute addresses delete "$IP_NAME" --global --quiet || true
              fi
            fi
          done
          
          echo "âœ… Enhanced force cleanup complete!"

      - name: Verify Destruction
        run: |
          echo "ðŸ” Verifying resource destruction..."
          
          REMAINING_CLUSTERS=$(gcloud container clusters list --filter="name~tx03-" --format="value(name)" | wc -l)
          REMAINING_SQL=$(gcloud sql instances list --filter="name~tx03-" --format="value(name)" | wc -l)
          REMAINING_LBS=$(gcloud compute forwarding-rules list --filter="name~tx03-" --format="value(name)" | wc -l)
          
          echo "Remaining resources:"
          echo "  GKE Clusters: $REMAINING_CLUSTERS"
          echo "  Cloud SQL: $REMAINING_SQL"
          echo "  Load Balancers: $REMAINING_LBS"
          
          TOTAL=$((REMAINING_CLUSTERS + REMAINING_SQL + REMAINING_LBS))
          
          if [ "$TOTAL" -eq "0" ]; then
            echo "âœ… All resources destroyed successfully!"
          else
            echo "âš ï¸  Warning: $TOTAL resources still remain. Manual cleanup may be required."
          fi

      - name: Upload Destroy Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: destroy-log-${{ env.ENVIRONMENT }}
          path: |
            terraform/environments/${{ env.ENVIRONMENT }}/destroy_plan_full.txt
            terraform/environments/${{ env.ENVIRONMENT }}/destroy_plan.txt
          retention-days: 30

  destroy-backend:
    name: Destroy Terraform Backend
    runs-on: ubuntu-latest
    needs: [destroy-infrastructure]
    if: github.event.inputs.destroy_backend == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Delete GCS Bucket
        run: |
          echo "ðŸ—‘ï¸  Deleting Terraform state bucket..."
          
          BUCKET="${{ secrets.GCS_BUCKET }}"
          
          # Remove versioning
          gcloud storage buckets update "gs://$BUCKET" --no-versioning || true
          
          # Delete all objects and versions
          gcloud storage rm -r "gs://$BUCKET/**" --all-versions || true
          
          # Delete bucket
          gcloud storage buckets delete "gs://$BUCKET" --quiet
          
          echo "âœ… Terraform backend destroyed!"

      - name: Cleanup Warning
        run: |
          echo "âš ï¸  IMPORTANT: Terraform backend has been destroyed!"
          echo ""
          echo "To use this project again, you must:"
          echo "1. Re-run the bootstrap workflow"
          echo "2. Update GCS_BUCKET secret with new bucket name"
          echo "3. Re-initialize Terraform in all environments"

  summary:
    name: Destruction Summary
    runs-on: ubuntu-latest
    needs: [destroy-infrastructure, destroy-backend]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ—‘ï¸  Destruction Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Initiated by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Backend destroyed:** ${{ github.event.inputs.destroy_backend }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ”„ Destruction Process" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… **K8s Resources Cleanup** - Deleted Ingresses, LoadBalancer Services, and PVCs" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… **Terraform Destroy** - Removed all infrastructure managed by Terraform" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… **Enhanced Force Cleanup** - Cleaned up:" >> $GITHUB_STEP_SUMMARY
          echo "   - GKE Clusters and node disks" >> $GITHUB_STEP_SUMMARY
          echo "   - Cloud SQL instances (with protection removal)" >> $GITHUB_STEP_SUMMARY
          echo "   - Load Balancer components (forwarding rules, proxies, URL maps)" >> $GITHUB_STEP_SUMMARY
          echo "   - Backend services" >> $GITHUB_STEP_SUMMARY
          echo "   - SSL certificates (managed and self-signed)" >> $GITHUB_STEP_SUMMARY
          echo "   - Orphaned persistent disks" >> $GITHUB_STEP_SUMMARY
          echo "   - K8s-created firewall rules" >> $GITHUB_STEP_SUMMARY
          echo "   - Static IP addresses" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.destroy-infrastructure.result }}" == "success" ]; then
            echo "âœ… **Infrastructure destroyed successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Infrastructure destruction failed or was cancelled**" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ github.event.inputs.destroy_backend }}" == "true" ]; then
            if [ "${{ needs.destroy-backend.result }}" == "success" ]; then
              echo "âœ… **Terraform backend destroyed successfully**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Terraform backend destruction failed**" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’° Cost Impact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Destroying infrastructure will stop incurring costs:" >> $GITHUB_STEP_SUMMARY
          echo "- **GKE Autopilot:** ~\$12-15/month saved" >> $GITHUB_STEP_SUMMARY
          echo "- **Cloud SQL:** ~\$12-15/month saved" >> $GITHUB_STEP_SUMMARY
          echo "- **Load Balancers:** ~\$20-25/month saved" >> $GITHUB_STEP_SUMMARY
          echo "- **Cloud Armor:** ~\$7-10/month saved" >> $GITHUB_STEP_SUMMARY
          echo "- **Other resources:** ~\$8-12/month saved" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ’µ Total savings:** ~\$60-77/month" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â­ï¸  Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… **Verify** all resources are deleted in [GCP Console](https://console.cloud.google.com/home/dashboard?project=${{ secrets.GCP_PROJECT_ID }})" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… **Check** for any orphaned resources:" >> $GITHUB_STEP_SUMMARY
          echo "   - [Compute Engine](https://console.cloud.google.com/compute/instances?project=${{ secrets.GCP_PROJECT_ID }})" >> $GITHUB_STEP_SUMMARY
          echo "   - [Load Balancing](https://console.cloud.google.com/net-services/loadbalancing/list?project=${{ secrets.GCP_PROJECT_ID }})" >> $GITHUB_STEP_SUMMARY
          echo "   - [Disks](https://console.cloud.google.com/compute/disks?project=${{ secrets.GCP_PROJECT_ID }})" >> $GITHUB_STEP_SUMMARY
          echo "   - [VPC Network](https://console.cloud.google.com/networking/networks/list?project=${{ secrets.GCP_PROJECT_ID }})" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… **Review** [Cloud Billing](https://console.cloud.google.com/billing) to confirm cost reduction" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… **Monitor** billing for next 7 days to ensure no unexpected charges" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ To Recreate Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.destroy_backend }}" == "true" ]; then
            echo "âš ï¸  **Backend was destroyed** - You must:" >> $GITHUB_STEP_SUMMARY
            echo "1. Run the bootstrap workflow to create new GCS bucket" >> $GITHUB_STEP_SUMMARY
            echo "2. Update \`GCS_BUCKET\` secret with new bucket name" >> $GITHUB_STEP_SUMMARY
            echo "3. Re-run terraform-apply workflow" >> $GITHUB_STEP_SUMMARY
          else
            echo "Simply run the **terraform-apply** workflow to recreate infrastructure" >> $GITHUB_STEP_SUMMARY
          fi
