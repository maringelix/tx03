name: ğŸ” Troubleshoot Pods

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  GCP_REGION: us-central1
  CLUSTER_NAME: tx03-gke-cluster
  NAMESPACE: dx03-dev

jobs:
  troubleshoot:
    runs-on: ubuntu-latest
    
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          install_components: 'gke-gcloud-auth-plugin'

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: ğŸ” Check Deployments
        run: |
          echo "======================================"
          echo "ğŸ“Š DEPLOYMENTS STATUS"
          echo "======================================"
          echo ""
          kubectl get deployments -n dx03-dev
          echo ""
          echo "Detailed deployment info:"
          kubectl describe deployment -n dx03-dev

      - name: ğŸ” Check ReplicaSets
        run: |
          echo ""
          echo "======================================"
          echo "ğŸ“Š REPLICASETS STATUS"
          echo "======================================"
          echo ""
          kubectl get replicasets -n dx03-dev
          echo ""
          echo "Detailed replicaset info:"
          kubectl describe replicaset -n dx03-dev | head -100

      - name: ğŸ” Check Pods
        run: |
          echo ""
          echo "======================================"
          echo "ğŸ“Š PODS STATUS"
          echo "======================================"
          echo ""
          kubectl get pods -n dx03-dev -o wide
          echo ""
          if [ $(kubectl get pods -n dx03-dev -o json | jq '.items | length') -gt 0 ]; then
            echo "Pod details:"
            kubectl describe pods -n dx03-dev | head -200
          else
            echo "âš ï¸ No pods found!"
          fi

      - name: ğŸ§¹ Detect CrashLooping Pods
        id: detect_crashes
        run: |
          echo ""
          echo "======================================"
          echo "ğŸ” DETECTING CRASHLOOPING PODS"
          echo "======================================"
          echo ""
          
          # Find ALL pods with high restart counts (including those in Pending phase with Init crashes)
          CRASHING_PODS=$(kubectl get pods -n dx03-dev -o json | \
            jq -r '.items[] | select(
              (.status.initContainerStatuses // [] | any(.restartCount > 5)) or 
              (.status.containerStatuses // [] | any(.restartCount > 5))
            ) | .metadata.name')
          
          if [ -z "$CRASHING_PODS" ]; then
            echo "âœ… No crashlooping pods found"
            echo "has_crashes=false" >> $GITHUB_OUTPUT
          else
            echo "âŒ Found crashlooping pods:"
            echo "$CRASHING_PODS"
            echo ""
            echo "has_crashes=true" >> $GITHUB_OUTPUT
            echo "crash_pods<<EOF" >> $GITHUB_OUTPUT
            echo "$CRASHING_PODS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            # Show details
            echo ""
            echo "Pod details:"
            for pod in $CRASHING_PODS; do
              echo ""
              echo "--- Pod: $pod ---"
              kubectl get pod $pod -n dx03-dev -o json | jq -r '.status | {phase, reason, message, containerStatuses, initContainerStatuses}'
              echo ""
              echo "Recent logs (init container):"
              kubectl logs $pod -n dx03-dev --previous --all-containers=true --tail=30 2>/dev/null || kubectl logs $pod -n dx03-dev --all-containers=true --tail=30 || echo "Failed to get logs"
            done
          fi

      - name: ğŸ§¹ Cleanup Old ReplicaSets
        if: steps.detect_crashes.outputs.has_crashes == 'true'
        run: |
          echo ""
          echo "======================================"
          echo "ğŸ§¹ CLEANING UP OLD REPLICASETS"
          echo "======================================"
          echo ""
          
          # Delete crashlooping pods directly
          echo "Deleting crashlooping pods..."
          PODS="${{ steps.detect_crashes.outputs.crash_pods }}"
          for pod in $PODS; do
            echo "Deleting pod: $pod"
            kubectl delete pod $pod -n dx03-dev --ignore-not-found=true --grace-period=0 --force
          done
          
          echo ""
          echo "Deleting old replicasets with 0 replicas..."
          # Get all replicasets with 0 desired pods
          kubectl get replicasets -n dx03-dev -o json | \
            jq -r '.items[] | select(.spec.replicas == 0) | .metadata.name' | \
            while read rs; do
              echo "Deleting old replicaset: $rs"
              kubectl delete replicaset $rs -n dx03-dev --ignore-not-found=true
            done
          
          echo ""
          echo "Remaining replicasets:"
          kubectl get replicasets -n dx03-dev

      - name: ğŸ§¹ Cleanup Trivy Scan Jobs
        run: |
          echo ""
          echo "======================================"
          echo "ğŸ§¹ CLEANING UP TRIVY SCAN JOBS"
          echo "======================================"
          echo ""
          
          # Get failed and completed Trivy scan jobs
          echo "Checking Trivy scan pods..."
          kubectl get pods -n trivy-system
          echo ""
          
          # Delete completed jobs (older than 1 hour)
          echo "Deleting old completed/failed scan jobs..."
          kubectl delete pods -n trivy-system \
            --field-selector=status.phase=Succeeded \
            --ignore-not-found=true || echo "No completed jobs to delete"
          
          kubectl delete pods -n trivy-system \
            --field-selector=status.phase=Failed \
            --ignore-not-found=true || echo "No failed jobs to delete"
          
          echo ""
          echo "Remaining Trivy pods:"
          kubectl get pods -n trivy-system

      - name: ğŸ” Check Events
        run: |
          echo ""
          echo "======================================"
          echo "ğŸ“Š RECENT EVENTS"
          echo "======================================"
          echo ""
          kubectl get events -n dx03-dev --sort-by='.lastTimestamp' | tail -50

      - name: ğŸ” Check Namespace
        run: |
          echo ""
          echo "======================================"
          echo "ğŸ“Š NAMESPACE INFO"
          echo "======================================"
          echo ""
          kubectl get namespace dx03-dev --show-labels
          kubectl describe namespace dx03-dev

      - name: ğŸ” Check Istio Webhook
        run: |
          echo ""
          echo "======================================"
          echo "ğŸ“Š ISTIO WEBHOOK STATUS"
          echo "======================================"
          echo ""
          kubectl get mutatingwebhookconfiguration istio-sidecar-injector -o yaml | grep -A20 namespaceSelector

      - name: ğŸ” Check Resource Quotas
        run: |
          echo ""
          echo "======================================"
          echo "ğŸ“Š RESOURCE QUOTAS"
          echo "======================================"
          echo ""
          kubectl get resourcequotas -n dx03-dev || echo "No resource quotas found"
          kubectl describe resourcequotas -n dx03-dev || echo "No resource quotas to describe"

      - name: ğŸ“‹ Summary
        run: |
          echo ""
          echo "======================================"
          echo "ğŸ“‹ TROUBLESHOOTING SUMMARY"
          echo "======================================"
          echo ""
          
          DEPLOYMENTS=$(kubectl get deployments -n dx03-dev -o json | jq '.items | length')
          PODS=$(kubectl get pods -n dx03-dev -o json | jq '.items | length')
          RUNNING_PODS=$(kubectl get pods -n dx03-dev --field-selector=status.phase=Running -o json | jq '.items | length')
          CRASHING_PODS=$(kubectl get pods -n dx03-dev --field-selector=status.phase!=Succeeded,status.phase!=Running -o json | \
            jq '.items[] | select(.status.containerStatuses // .status.initContainerStatuses | any(.restartCount > 5))' | jq -s 'length')
          
          echo "Deployments: $DEPLOYMENTS"
          echo "Total Pods: $PODS"
          echo "Running Pods: $RUNNING_PODS"
          echo "Crashing Pods: $CRASHING_PODS"
          echo ""
          
          if [ "$CRASHING_PODS" -gt 0 ]; then
            echo "ğŸ§¹ Cleaned up $CRASHING_PODS crashlooping pod(s)"
            echo "âœ… Old replicasets removed"
          fi
          
          if [ "$RUNNING_PODS" -eq 0 ] && [ "$DEPLOYMENTS" -gt 0 ]; then
            echo "âŒ ISSUE: Deployments exist but no running pods!"
            echo "Check events and deployment descriptions above for root cause"
          elif [ "$RUNNING_PODS" -gt 0 ]; then
            echo "âœ… $RUNNING_PODS pod(s) running successfully"
          else
            echo "âš ï¸ No deployments or pods found - may have been deleted"
          fi
          
          echo ""
          echo "Final cluster state:"
          kubectl get all -n dx03-dev
          
      - name: ğŸ“Š Verify Cleanup Success
        run: |
          echo ""
          echo "======================================"
          echo "âœ… VERIFICATION"
          echo "======================================"
          echo ""
          
          # Wait a bit for cleanup to complete and pods to restart
          echo "Waiting 30 seconds for pods to restart..."
          sleep 30
          
          echo ""
          echo "Current pod status:"
          kubectl get pods -n dx03-dev
          echo ""
          
          CRASHING=$(kubectl get pods -n dx03-dev -o json | \
            jq '.items[] | select(
              (.status.initContainerStatuses // [] | any(.restartCount > 5)) or 
              (.status.containerStatuses // [] | any(.restartCount > 5))
            )' | jq -s 'length')
          
          if [ "$CRASHING" -eq 0 ]; then
            echo "âœ… SUCCESS: No crashlooping pods remaining"
            echo ""
            echo "All pods are healthy!"
          else
            echo "âš ï¸ WARNING: Still $CRASHING crashlooping pod(s) detected"
            echo "Pods may still be restarting or there's a deeper issue."
            echo ""
            echo "Checking restart counts..."
            kubectl get pods -n dx03-dev -o json | jq -r '.items[] | select(
              (.status.initContainerStatuses // [] | any(.restartCount > 0)) or 
              (.status.containerStatuses // [] | any(.restartCount > 0))
            ) | "\(.metadata.name): \(.status.initContainerStatuses[0].restartCount // 0) init restarts, \(.status.containerStatuses[0].restartCount // 0) container restarts"'
          fi
