name: üîç Troubleshoot Pods

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  GCP_PROJECT_ID: project-28e61e96-b6ac-4249-a21f
  GCP_REGION: us-central1
  CLUSTER_NAME: tx03-gke-cluster

jobs:
  troubleshoot:
    runs-on: ubuntu-latest
    
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          install_components: 'gke-gcloud-auth-plugin'

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: üîç Check Deployments
        run: |
          echo "======================================"
          echo "üìä DEPLOYMENTS STATUS"
          echo "======================================"
          echo ""
          kubectl get deployments -n dx03-dev
          echo ""
          echo "Detailed deployment info:"
          kubectl describe deployment -n dx03-dev

      - name: üîç Check ReplicaSets
        run: |
          echo ""
          echo "======================================"
          echo "üìä REPLICASETS STATUS"
          echo "======================================"
          echo ""
          kubectl get replicasets -n dx03-dev
          echo ""
          echo "Detailed replicaset info:"
          kubectl describe replicaset -n dx03-dev | head -100

      - name: üîç Check Pods
        run: |
          echo ""
          echo "======================================"
          echo "üìä PODS STATUS"
          echo "======================================"
          echo ""
          kubectl get pods -n dx03-dev -o wide
          echo ""
          if [ $(kubectl get pods -n dx03-dev -o json | jq '.items | length') -gt 0 ]; then
            echo "Pod details:"
            kubectl describe pods -n dx03-dev | head -200
          else
            echo "‚ö†Ô∏è No pods found!"
          fi

      - name: üßπ Detect CrashLooping Pods
        id: detect_crashes
        run: |
          echo ""
          echo "======================================"
          echo "üîç DETECTING CRASHLOOPING PODS"
          echo "======================================"
          echo ""
          
          # Find pods in CrashLoopBackOff or Init:CrashLoopBackOff
          CRASHING_PODS=$(kubectl get pods -n dx03-dev --field-selector=status.phase!=Succeeded,status.phase!=Running -o json | \
            jq -r '.items[] | select(.status.containerStatuses // .status.initContainerStatuses | any(.restartCount > 5)) | .metadata.name')
          
          if [ -z "$CRASHING_PODS" ]; then
            echo "‚úÖ No crashlooping pods found"
            echo "has_crashes=false" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Found crashlooping pods:"
            echo "$CRASHING_PODS"
            echo ""
            echo "has_crashes=true" >> $GITHUB_OUTPUT
            echo "crash_pods<<EOF" >> $GITHUB_OUTPUT
            echo "$CRASHING_PODS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            # Show details
            echo ""
            echo "Pod details:"
            for pod in $CRASHING_PODS; do
              echo ""
              echo "--- Pod: $pod ---"
              kubectl get pod $pod -n dx03-dev -o json | jq -r '.status | {phase, reason, message, containerStatuses, initContainerStatuses}'
              echo ""
              echo "Recent logs:"
              kubectl logs $pod -n dx03-dev --tail=20 --all-containers=true || echo "Failed to get logs"
            done
          fi

      - name: üßπ Cleanup Old ReplicaSets
        if: steps.detect_crashes.outputs.has_crashes == 'true'
        run: |
          echo ""
          echo "======================================"
          echo "üßπ CLEANING UP OLD REPLICASETS"
          echo "======================================"
          echo ""
          
          # Get all replicasets with 0 desired pods
          echo "Finding old replicasets..."
          kubectl get replicasets -n dx03-dev -o json | \
            jq -r '.items[] | select(.spec.replicas == 0) | .metadata.name' | \
            while read rs; do
              echo "Deleting old replicaset: $rs"
              kubectl delete replicaset $rs -n dx03-dev --ignore-not-found=true
            done
          
          echo ""
          echo "Remaining replicasets:"
          kubectl get replicasets -n dx03-dev

      - name: üßπ Cleanup Trivy Scan Jobs
        run: |
          echo ""
          echo "======================================"
          echo "üßπ CLEANING UP TRIVY SCAN JOBS"
          echo "======================================"
          echo ""
          
          # Get failed and completed Trivy scan jobs
          echo "Checking Trivy scan pods..."
          kubectl get pods -n trivy-system
          echo ""
          
          # Delete completed jobs (older than 1 hour)
          echo "Deleting old completed/failed scan jobs..."
          kubectl delete pods -n trivy-system \
            --field-selector=status.phase=Succeeded \
            --ignore-not-found=true || echo "No completed jobs to delete"
          
          kubectl delete pods -n trivy-system \
            --field-selector=status.phase=Failed \
            --ignore-not-found=true || echo "No failed jobs to delete"
          
          echo ""
          echo "Remaining Trivy pods:"
          kubectl get pods -n trivy-system

      - name: üîç Check Events
        run: |
          echo ""
          echo "======================================"
          echo "üìä RECENT EVENTS"
          echo "======================================"
          echo ""
          kubectl get events -n dx03-dev --sort-by='.lastTimestamp' | tail -50

      - name: üîç Check Namespace
        run: |
          echo ""
          echo "======================================"
          echo "üìä NAMESPACE INFO"
          echo "======================================"
          echo ""
          kubectl get namespace dx03-dev --show-labels
          kubectl describe namespace dx03-dev

      - name: üîç Check Istio Webhook
        run: |
          echo ""
          echo "======================================"
          echo "üìä ISTIO WEBHOOK STATUS"
          echo "======================================"
          echo ""
          kubectl get mutatingwebhookconfiguration istio-sidecar-injector -o yaml | grep -A20 namespaceSelector

      - name: üîç Check Resource Quotas
        run: |
          echo ""
          echo "======================================"
          echo "üìä RESOURCE QUOTAS"
          echo "======================================"
          echo ""
          kubectl get resourcequotas -n dx03-dev || echo "No resource quotas found"
          kubectl describe resourcequotas -n dx03-dev || echo "No resource quotas to describe"

      - name: üìã Summary
        run: |
          echo ""
          echo "======================================"
          echo "üìã TROUBLESHOOTING SUMMARY"
          echo "======================================"
          echo ""
          
          DEPLOYMENTS=$(kubectl get deployments -n dx03-dev -o json | jq '.items | length')
          PODS=$(kubectl get pods -n dx03-dev -o json | jq '.items | length')
          RUNNING_PODS=$(kubectl get pods -n dx03-dev --field-selector=status.phase=Running -o json | jq '.items | length')
          CRASHING_PODS=$(kubectl get pods -n dx03-dev --field-selector=status.phase!=Succeeded,status.phase!=Running -o json | \
            jq '.items[] | select(.status.containerStatuses // .status.initContainerStatuses | any(.restartCount > 5))' | jq -s 'length')
          
          echo "Deployments: $DEPLOYMENTS"
          echo "Total Pods: $PODS"
          echo "Running Pods: $RUNNING_PODS"
          echo "Crashing Pods: $CRASHING_PODS"
          echo ""
          
          if [ "$CRASHING_PODS" -gt 0 ]; then
            echo "üßπ Cleaned up $CRASHING_PODS crashlooping pod(s)"
            echo "‚úÖ Old replicasets removed"
          fi
          
          if [ "$RUNNING_PODS" -eq 0 ] && [ "$DEPLOYMENTS" -gt 0 ]; then
            echo "‚ùå ISSUE: Deployments exist but no running pods!"
            echo "Check events and deployment descriptions above for root cause"
          elif [ "$RUNNING_PODS" -gt 0 ]; then
            echo "‚úÖ $RUNNING_PODS pod(s) running successfully"
          else
            echo "‚ö†Ô∏è No deployments or pods found - may have been deleted"
          fi
          
          echo ""
          echo "Final cluster state:"
          kubectl get all -n dx03-dev
          
      - name: üìä Verify Cleanup Success
        run: |
          echo ""
          echo "======================================"
          echo "‚úÖ VERIFICATION"
          echo "======================================"
          echo ""
          
          # Wait a bit for cleanup to complete
          sleep 10
          
          echo "Current pod status:"
          kubectl get pods -n dx03-dev
          echo ""
          
          CRASHING=$(kubectl get pods -n dx03-dev --field-selector=status.phase!=Succeeded,status.phase!=Running -o json | \
            jq '.items[] | select(.status.containerStatuses // .status.initContainerStatuses | any(.restartCount > 5))' | jq -s 'length')
          
          if [ "$CRASHING" -eq 0 ]; then
            echo "‚úÖ SUCCESS: No crashlooping pods remaining"
          else
            echo "‚ö†Ô∏è WARNING: Still $CRASHING crashlooping pod(s) detected"
            echo "These may be new issues that require investigation"
          fi
