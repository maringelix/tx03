name: üîç Fix Istio Sidecar Injection

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'diagnose'
        type: choice
        options:
          - diagnose
          - disable-injection
          - enable-injection
          - force-recreate

permissions:
  contents: read
  id-token: write

env:
  GCP_REGION: us-central1
  CLUSTER_NAME: tx03-gke-cluster

jobs:
  fix-sidecar-injection:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          install_components: 'gke-gcloud-auth-plugin'

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: üîç Diagnose Sidecar Injection
        id: diagnose
        run: |
          echo "======================================"
          echo "üîç DIAGN√ìSTICO DE SIDECAR INJECTION"
          echo "======================================"
          echo ""
          
          echo "1Ô∏è‚É£ Verificando Mutating Webhooks..."
          echo "-------------------------------------"
          kubectl get mutatingwebhookconfiguration | grep -i istio || echo "‚ö†Ô∏è  Nenhum webhook do Istio encontrado"
          echo ""
          
          echo "2Ô∏è‚É£ Verificando Namespace Label..."
          echo "-------------------------------------"
          kubectl get namespace dx03-dev --show-labels
          LABEL=$(kubectl get namespace dx03-dev -o jsonpath='{.metadata.labels.istio-injection}')
          if [ "$LABEL" == "enabled" ]; then
            echo "‚úÖ Namespace tem label istio-injection=enabled"
          else
            echo "‚ùå Namespace N√ÉO tem label istio-injection"
          fi
          echo ""
          
          echo "3Ô∏è‚É£ Verificando Webhook do Istio..."
          echo "-------------------------------------"
          kubectl get mutatingwebhookconfiguration istio-sidecar-injector -o yaml | grep -A5 "namespaceSelector" || echo "‚ö†Ô∏è  Webhook istio-sidecar-injector n√£o encontrado"
          echo ""
          
          echo "4Ô∏è‚É£ Verificando Pods Atuais..."
          echo "-------------------------------------"
          kubectl get pods -n dx03-dev -o wide
          echo ""
          
          echo "5Ô∏è‚É£ Verificando Containers nos Pods..."
          echo "-------------------------------------"
          kubectl get pods -n dx03-dev -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[*].name}{"\n"}{end}'
          echo ""
          
          echo "6Ô∏è‚É£ Verificando Annotations dos Pods..."
          echo "-------------------------------------"
          for pod in $(kubectl get pods -n dx03-dev -o jsonpath='{.items[*].metadata.name}'); do
            echo "Pod: $pod"
            kubectl get pod $pod -n dx03-dev -o jsonpath='{.metadata.annotations}' | jq . || echo "No annotations"
            echo ""
          done
          
          echo "7Ô∏è‚É£ Verificando Istiod Logs (√∫ltimas 50 linhas)..."
          echo "-------------------------------------"
          kubectl logs -n istio-system deployment/istiod --tail=50 | grep -i "inject\|webhook\|dx03-dev" || echo "Nenhum log relevante encontrado"
          echo ""

      - name: ÔøΩ Disable Sidecar Injection
        if: inputs.action == 'disable-injection'
        run: |
          echo "======================================"
          echo "üö´ DESABILITANDO SIDECAR INJECTION"
          echo "======================================"
          echo ""
          
          echo "Removendo label istio-injection do namespace..."
          kubectl label namespace dx03-dev istio-injection- --ignore-not-found=true
          echo "‚úÖ Label removido"
          
          echo ""
          echo "Verificando namespace atualizado..."
          kubectl get namespace dx03-dev --show-labels
          
          echo ""
          echo "üóëÔ∏è  Deletando pods crashlooping com sidecars..."
          # Delete apenas pods com init container istio-validation
          kubectl get pods -n dx03-dev -o json | \
            jq -r '.items[] | select(.spec.initContainers[]?.name == "istio-validation") | .metadata.name' | \
            while read pod; do
              echo "Deletando pod com sidecar: $pod"
              kubectl delete pod $pod -n dx03-dev --grace-period=0 --force
            done
          
          echo ""
          echo "‚è≥ Aguardando novos pods sem sidecars serem criados (30s)..."
          sleep 30
          
          echo ""
          echo "üìä Status dos pods (devem ter apenas 1 container cada):"
          kubectl get pods -n dx03-dev -o wide
          
          echo ""
          echo "Verificando containers por pod:"
          kubectl get pods -n dx03-dev -o json | jq -r '.items[] | "\(.metadata.name): \(.spec.containers | length) container(s)"'

      - name: ‚úÖ Enable Sidecar Injection
        if: inputs.action == 'enable-injection'
        run: |
          echo "======================================"
          echo "‚úÖ HABILITANDO SIDECAR INJECTION"
          echo "======================================"
          echo ""
          
          echo "Adicionando label istio-injection ao namespace..."
          kubectl label namespace dx03-dev istio-injection=enabled --overwrite
          echo "‚úÖ Label adicionado"
          
          echo ""
          echo "Verificando namespace atualizado..."
          kubectl get namespace dx03-dev --show-labels
          
          echo ""
          echo "üóëÔ∏è  Deletando pods existentes para for√ßar inje√ß√£o..."
          kubectl delete pod --all -n dx03-dev
          
          echo ""
          echo "‚è≥ Aguardando novos pods com sidecars serem criados (60s)..."
          sleep 60
          
          echo ""
          echo "üìä Status dos pods (devem ter 2 containers cada):"
          kubectl get pods -n dx03-dev -o wide
          
          echo ""
          echo "Verificando containers por pod:"
          kubectl get pods -n dx03-dev -o json | jq -r '.items[] | "\(.metadata.name): \(.spec.containers | length) container(s)"'

      - name: ÔøΩüîß Fix - Verificar e Reinstalar Webhook
        if: inputs.action == 'fix'
        run: |
          echo "======================================"
          echo "üîß CORRIGINDO WEBHOOK CONFIGURATION"
          echo "======================================"
          echo ""
          
          # Verificar se webhook existe
          if ! kubectl get mutatingwebhookconfiguration istio-sidecar-injector &>/dev/null; then
            echo "‚ùå Webhook istio-sidecar-injector n√£o encontrado!"
            echo "üîÑ Reinstalando webhook..."
            
            # Tentar aplicar novamente a configura√ß√£o do Istio
            istioctl install --set profile=default -y
            
            echo "‚úÖ Webhook reinstalado"
          else
            echo "‚úÖ Webhook existe"
          fi
          
          # Verificar e corrigir namespace label
          echo ""
          echo "üîß Verificando namespace label..."
          kubectl label namespace dx03-dev istio-injection=enabled --overwrite
          echo "‚úÖ Namespace label atualizado"
          
          # Restart istiod para garantir que est√° funcionando
          echo ""
          echo "üîÑ Reiniciando istiod..."
          kubectl rollout restart deployment/istiod -n istio-system
          kubectl rollout status deployment/istiod -n istio-system --timeout=3m
          echo "‚úÖ Istiod reiniciado"
          
          echo ""
          echo "‚è≥ Aguardando webhook estabilizar (30s)..."
          sleep 30

      - name: üöÄ Force Recreate Pods
        if: inputs.action == 'fix' || inputs.action == 'force-recreate'
        run: |
          echo "======================================"
          echo "üöÄ FOR√áANDO RECRIA√á√ÉO DOS PODS"
          echo "======================================"
          echo ""
          
          echo "üóëÔ∏è  Deletando pods existentes..."
          kubectl delete pod --all -n dx03-dev
          
          echo ""
          echo "‚è≥ Aguardando novos pods serem criados (60s)..."
          sleep 60
          
          echo ""
          echo "üìä Status dos novos pods:"
          kubectl get pods -n dx03-dev -o wide
          
          echo ""
          echo "üîç Verificando containers:"
          kubectl get pods -n dx03-dev -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[*].name}{"\n"}{end}'

      - name: ‚úÖ Validate Sidecar Injection
        if: inputs.action == 'fix' || inputs.action == 'force-recreate'
        run: |
          echo "======================================"
          echo "‚úÖ VALIDA√á√ÉO FINAL"
          echo "======================================"
          echo ""
          
          echo "Aguardando todos os pods ficarem ready..."
          kubectl wait --for=condition=ready pod --all -n dx03-dev --timeout=5m || true
          
          echo ""
          echo "üìä Status Final dos Pods:"
          kubectl get pods -n dx03-dev
          
          echo ""
          echo "üîç Containers em cada pod:"
          kubectl get pods -n dx03-dev -o jsonpath='{range .items[*]}{.metadata.name}{": "}{.status.containerStatuses[*].name}{"\n"}{end}'
          
          echo ""
          echo "üéØ Verificando sidecars:"
          TOTAL_PODS=$(kubectl get pods -n dx03-dev -o json | jq '.items | length')
          PODS_WITH_SIDECAR=$(kubectl get pods -n dx03-dev -o json | jq '[.items[] | select(.spec.containers | length > 1)] | length')
          
          echo "Total de pods: $TOTAL_PODS"
          echo "Pods com sidecar: $PODS_WITH_SIDECAR"
          
          if [ "$TOTAL_PODS" -eq "$PODS_WITH_SIDECAR" ]; then
            echo "‚úÖ SUCESSO! Todos os pods t√™m sidecar injetado!"
          else
            echo "‚ùå FALHA! Alguns pods n√£o t√™m sidecar"
            echo ""
            echo "Pods SEM sidecar:"
            kubectl get pods -n dx03-dev -o json | jq -r '.items[] | select(.spec.containers | length == 1) | .metadata.name'
            exit 1
          fi

      - name: üìù Summary
        if: always()
        run: |
          echo ""
          echo "======================================"
          echo "üìù RESUMO"
          echo "======================================"
          echo "Action: ${{ inputs.action }}"
          echo "Cluster: tx03-gke-cluster"
          echo "Namespace: dx03-dev"
          echo ""
          
          if [ "${{ inputs.action }}" == "diagnose" ]; then
            echo "‚úÖ Diagn√≥stico completo!"
            echo "üëâ Analise os logs acima para identificar o problema"
            echo "üëâ Execute novamente com action='fix' para corrigir"
          else
            echo "‚úÖ Fix aplicado!"
            echo "üëâ Verifique a se√ß√£o 'Validate Sidecar Injection' acima"
          fi
