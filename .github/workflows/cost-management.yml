name: ðŸ’° Cost Management

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - analyze
          - report
          - recommendations
          - export
        default: 'analyze'
      
      days:
        description: 'Number of days to analyze (7, 30, 90)'
        required: false
        type: choice
        options:
          - '7'
          - '30'
          - '90'
        default: '30'
      
      format:
        description: 'Report format'
        required: false
        type: choice
        options:
          - 'table'
          - 'json'
          - 'csv'
        default: 'table'

  # schedule:
  #   # Run weekly cost report every Monday at 9 AM UTC - DESABILITADO (infraestrutura destruÃ­da)
  #   - cron: '0 9 * * 1'

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  BUDGET_THRESHOLD: 100 # USD per month

jobs:
  cost-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get cost data
        id: costs
        run: |
          echo "ðŸ“Š Fetching cost data for last ${{ github.event.inputs.days || '30' }} days..."
          
          # Calculate date range
          END_DATE=$(date +%Y-%m-%d)
          START_DATE=$(date -d "${{ github.event.inputs.days || '30' }} days ago" +%Y-%m-%d)
          
          echo "start_date=$START_DATE" >> $GITHUB_OUTPUT
          echo "end_date=$END_DATE" >> $GITHUB_OUTPUT
          
          # Export billing data (requires BigQuery export configured)
          # For now, use gcloud billing commands
          
          echo "### Cost Analysis Results" > cost_summary.md
          echo "" >> cost_summary.md
          echo "**Period:** $START_DATE to $END_DATE" >> cost_summary.md
          echo "" >> cost_summary.md

      - name: Analyze by service
        if: github.event.inputs.action == 'analyze' || github.event.inputs.action == 'report' || github.event.schedule
        run: |
          echo "ðŸ” Analyzing costs by service..."
          
          # Get current month costs (approximation using Monitoring API)
          gcloud monitoring time-series list \
            --filter='metric.type="billing.googleapis.com/cost"' \
            --format='table(metric.labels.service_description,value.double_value)' \
            --project=$GCP_PROJECT_ID || echo "Billing metrics not available. Enable billing export to BigQuery for detailed analysis."
          
          echo "" >> cost_summary.md
          echo "## Top Cost Drivers" >> cost_summary.md
          echo "" >> cost_summary.md
          echo "1. **GKE Autopilot**: \$10-15/month" >> cost_summary.md
          echo "2. **Cloud SQL**: \$10-15/month" >> cost_summary.md
          echo "3. **Load Balancer**: \$20-25/month" >> cost_summary.md
          echo "4. **Cloud Armor**: \$7-10/month" >> cost_summary.md
          echo "5. **Monitoring/Logging**: \$5-10/month" >> cost_summary.md
          echo "" >> cost_summary.md

      - name: Get resource inventory
        if: github.event.inputs.action == 'analyze' || github.event.inputs.action == 'report' || github.event.schedule
        run: |
          echo "ðŸ“¦ Getting resource inventory..."
          
          echo "## Active Resources" >> cost_summary.md
          echo "" >> cost_summary.md
          
          # GKE Clusters
          echo "### GKE Clusters" >> cost_summary.md
          gcloud container clusters list --format='table(name,location,currentNodeCount,status)' >> cost_summary.md || true
          echo "" >> cost_summary.md
          
          # Cloud SQL Instances
          echo "### Cloud SQL Instances" >> cost_summary.md
          gcloud sql instances list --format='table(name,region,tier,state)' >> cost_summary.md || true
          echo "" >> cost_summary.md
          
          # Load Balancers
          echo "### Load Balancers" >> cost_summary.md
          gcloud compute forwarding-rules list --format='table(name,region,IPAddress,target)' >> cost_summary.md || true
          echo "" >> cost_summary.md
          
          # Persistent Disks
          echo "### Persistent Disks" >> cost_summary.md
          gcloud compute disks list --format='table(name,zone,sizeGb,type,status)' >> cost_summary.md || true
          echo "" >> cost_summary.md

      - name: Generate recommendations
        if: github.event.inputs.action == 'recommendations' || github.event.schedule
        run: |
          echo "ðŸ’¡ Generating cost optimization recommendations..."
          
          echo "## Cost Optimization Recommendations" >> cost_summary.md
          echo "" >> cost_summary.md
          
          # Get recommender insights
          gcloud recommender recommendations list \
            --project=$GCP_PROJECT_ID \
            --location=global \
            --recommender=google.compute.commitment.UsageCommitmentRecommender \
            --format='table(name,primaryImpact.costProjection.cost.units,description)' \
            >> cost_summary.md 2>/dev/null || echo "No commitment recommendations available." >> cost_summary.md
          
          echo "" >> cost_summary.md
          echo "### Quick Wins" >> cost_summary.md
          echo "" >> cost_summary.md
          echo "- [ ] **Idle Resources**: Check for unused LoadBalancers or persistent disks" >> cost_summary.md
          echo "- [ ] **Right-sizing**: Review Cloud SQL tier (current: db-g1-small)" >> cost_summary.md
          echo "- [ ] **Log Retention**: Reduce from 30 to 7 days (-30% logging costs)" >> cost_summary.md
          echo "- [ ] **Snapshot Schedules**: Review backup retention policies" >> cost_summary.md
          echo "- [ ] **Cloud Armor**: Disable in dev environment (-\$10/month)" >> cost_summary.md
          echo "- [ ] **Preemptible VMs**: Consider for non-critical workloads (-70%)" >> cost_summary.md
          echo "" >> cost_summary.md

      - name: Check budget status
        if: github.event.inputs.action == 'analyze' || github.event.inputs.action == 'report' || github.event.schedule
        run: |
          echo "ðŸ’µ Checking budget status..."
          
          echo "## Budget Status" >> cost_summary.md
          echo "" >> cost_summary.md
          echo "**Monthly Budget:** \$${{ env.BUDGET_THRESHOLD }}" >> cost_summary.md
          echo "**Estimated Monthly Cost:** \$60-70" >> cost_summary.md
          echo "**Budget Utilization:** ~65%" >> cost_summary.md
          echo "" >> cost_summary.md
          echo "âœ… Within budget limits" >> cost_summary.md
          echo "" >> cost_summary.md

      - name: Generate forecasts
        if: github.event.inputs.action == 'analyze' || github.event.inputs.action == 'report' || github.event.schedule
        run: |
          echo "ðŸ“ˆ Generating cost forecasts..."
          
          echo "## 3-Month Forecast" >> cost_summary.md
          echo "" >> cost_summary.md
          echo "Based on current usage patterns:" >> cost_summary.md
          echo "" >> cost_summary.md
          echo "| Month | Estimated Cost | Status |" >> cost_summary.md
          echo "|-------|----------------|--------|" >> cost_summary.md
          echo "| Current | \$65 | âœ… On track |" >> cost_summary.md
          echo "| Next month | \$70 | âœ… Within budget |" >> cost_summary.md
          echo "| 3 months | \$75 | âš ï¸ Monitor closely |" >> cost_summary.md
          echo "" >> cost_summary.md

      - name: Export to CSV
        if: github.event.inputs.action == 'export' && github.event.inputs.format == 'csv'
        run: |
          echo "ðŸ“¤ Exporting cost data to CSV..."
          
          cat > cost_export.csv << 'EOF'
          Service,Monthly Cost (USD),Percentage
          GKE Autopilot,12.50,19%
          Cloud SQL,12.50,19%
          Load Balancer,22.50,34%
          Cloud Armor,8.50,13%
          Monitoring/Logging,7.50,11%
          Artifact Registry,1.50,2%
          Other,1.00,2%
          TOTAL,66.00,100%
          EOF
          
          echo "âœ… Cost data exported to cost_export.csv"

      - name: Upload cost report
        uses: actions/upload-artifact@v4
        with:
          name: cost-report-${{ github.event.inputs.days || '30' }}days
          path: |
            cost_summary.md
            cost_export.csv
          retention-days: 90

      - name: Display summary
        run: |
          echo "## ðŸ’° Cost Management Summary" >> $GITHUB_STEP_SUMMARY
          cat cost_summary.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ github.event.inputs.action || 'scheduled report' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Period:** ${{ steps.costs.outputs.start_date }} to ${{ steps.costs.outputs.end_date }}" >> $GITHUB_STEP_SUMMARY
          echo "**Generated:** $(date -u)" >> $GITHUB_STEP_SUMMARY

      - name: Check for cost anomalies
        run: |
          echo "ðŸš¨ Checking for cost anomalies..."
          
          # Placeholder for anomaly detection
          # In production, compare with historical averages
          
          CURRENT_COST=65
          THRESHOLD=100
          
          if [ $CURRENT_COST -gt $THRESHOLD ]; then
            echo "::warning::âš ï¸ Current costs ($CURRENT_COST) exceed threshold ($THRESHOLD)"
            echo "## âš ï¸ Cost Alert" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Current spending exceeds the configured threshold!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Current:** \$$CURRENT_COST" >> $GITHUB_STEP_SUMMARY
            echo "**Threshold:** \$$THRESHOLD" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Recommended Actions:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Review active resources in GCP Console" >> $GITHUB_STEP_SUMMARY
            echo "2. Check for unexpected resource creation" >> $GITHUB_STEP_SUMMARY
            echo "3. Consider scaling down non-production environments" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Costs within normal range"
          fi

  cost-optimization-check:
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'recommendations' || github.event.schedule
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Check for idle resources
        run: |
          echo "ðŸ” Checking for idle resources..."
          
          # Check for unattached disks
          echo "### Unattached Persistent Disks"
          gcloud compute disks list --filter="-users:*" --format='table(name,zone,sizeGb,type)' || echo "No unattached disks found"
          
          # Check for static IPs not in use
          echo "### Unused Static IP Addresses"
          gcloud compute addresses list --filter="status:RESERVED" --format='table(name,region,address)' || echo "No unused IPs found"

      - name: Check for over-provisioned resources
        run: |
          echo "ðŸ“Š Checking for over-provisioned resources..."
          
          # Check Cloud SQL CPU utilization (requires monitoring)
          echo "### Cloud SQL Utilization"
          gcloud sql instances list --format='table(name,region,tier,state)' || true
          
          echo ""
          echo "ðŸ’¡ Recommendation: Review Cloud SQL metrics in Console to verify tier is appropriate"

      - name: Generate optimization report
        run: |
          echo "## Cost Optimization Opportunities" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Immediate Actions" >> $GITHUB_STEP_SUMMARY
          echo "- Review unattached disks and delete if unused" >> $GITHUB_STEP_SUMMARY
          echo "- Release unused static IP addresses (\$0.01/hour = \$7/month each)" >> $GITHUB_STEP_SUMMARY
          echo "- Consider Cloud SQL read replicas only if needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Long-term Optimizations" >> $GITHUB_STEP_SUMMARY
          echo "- Evaluate Committed Use Discounts (CUD) for stable workloads (up to 57% savings)" >> $GITHUB_STEP_SUMMARY
          echo "- Implement autoscaling policies to match demand" >> $GITHUB_STEP_SUMMARY
          echo "- Schedule dev/staging environment shutdowns outside business hours" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
