name: Deploy Istio Service Mesh

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'install'
        type: choice
        options:
          - install
          - upgrade
          - uninstall
      profile:
        description: 'Istio configuration profile'
        required: true
        default: 'default'
        type: choice
        options:
          - default
          - demo
          - minimal
          - ambient
      enable_addons:
        description: 'Install Istio addons (Kiali, Jaeger, Prometheus, Grafana)'
        required: false
        default: true
        type: boolean

env:
  GCP_REGION: us-central1
  CLUSTER_NAME: tx03-gke-cluster
  ISTIO_VERSION: 1.20.1
  ISTIO_NAMESPACE: istio-system

jobs:
  deploy-istio:
    name: ${{ inputs.action }} Istio Service Mesh
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: ‚òÅÔ∏è Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'gke-gcloud-auth-plugin'

      - name: üîß Configure kubectl
        run: |
          gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}
          
          echo "‚úÖ kubectl configured"
          kubectl cluster-info

      - name: üì¶ Download and Install Istio CLI (istioctl)
        if: inputs.action != 'uninstall'
        run: |
          echo "üì• Downloading Istio ${{ env.ISTIO_VERSION }}..."
          curl -L https://istio.io/downloadIstio | ISTIO_VERSION=${{ env.ISTIO_VERSION }} sh -
          
          cd istio-${{ env.ISTIO_VERSION }}
          sudo mv bin/istioctl /usr/local/bin/
          
          echo "‚úÖ Istio CLI installed"
          istioctl version --remote=false

      - name: üöÄ Install Istio
        if: inputs.action == 'install'
        run: |
          echo "üöÄ Installing Istio with profile: ${{ inputs.profile }}"
          
          # Pre-check
          istioctl x precheck
          
          # Install Istio
          istioctl install \
            --set profile=${{ inputs.profile }} \
            --set meshConfig.accessLogFile=/dev/stdout \
            --set meshConfig.enableTracing=true \
            --set meshConfig.defaultConfig.tracing.zipkin.address=jaeger-collector.istio-system.svc:9411 \
            --skip-confirmation
          
          echo "‚úÖ Istio installed successfully"

      - name: ‚¨ÜÔ∏è Upgrade Istio
        if: inputs.action == 'upgrade'
        run: |
          echo "‚¨ÜÔ∏è Upgrading Istio..."
          
          istioctl upgrade \
            --set profile=${{ inputs.profile }} \
            --skip-confirmation
          
          echo "‚úÖ Istio upgraded successfully"

      - name: üóëÔ∏è Uninstall Istio
        if: inputs.action == 'uninstall'
        continue-on-error: true
        run: |
          echo "üóëÔ∏è Uninstalling Istio..."
          
          # Remove Istio installation
          istioctl uninstall --purge --skip-confirmation || true
          
          # Delete namespace
          kubectl delete namespace ${{ env.ISTIO_NAMESPACE }} --ignore-not-found=true
          
          echo "‚úÖ Istio uninstalled"

      - name: üè∑Ô∏è Label namespace for sidecar injection
        if: inputs.action == 'install' || inputs.action == 'upgrade'
        run: |
          echo "üè∑Ô∏è Enabling automatic sidecar injection for dx03-dev namespace..."
          
          kubectl label namespace dx03-dev istio-injection=enabled --overwrite
          
          echo "‚úÖ Namespace labeled for sidecar injection"
          kubectl get namespace -L istio-injection

      - name: üìä Install Istio Addons
        if: (inputs.action == 'install' || inputs.action == 'upgrade') && inputs.enable_addons
        run: |
          echo "üìä Installing Istio addons (Kiali, Jaeger, Prometheus, Grafana)..."
          
          cd istio-${{ env.ISTIO_VERSION }}
          
          # Install Prometheus (if not already installed)
          kubectl apply -f samples/addons/prometheus.yaml || true
          
          # Install Grafana
          kubectl apply -f samples/addons/grafana.yaml || true
          
          # Install Jaeger
          kubectl apply -f samples/addons/jaeger.yaml || true
          
          # Install Kiali
          kubectl apply -f samples/addons/kiali.yaml || true
          
          echo "‚è≥ Waiting for addons to be ready..."
          kubectl rollout status deployment/kiali -n istio-system --timeout=300s || true
          
          echo "‚úÖ Addons installed"

      - name: ‚ö†Ô∏è Manual Steps Required
        if: inputs.action == 'install' || inputs.action == 'upgrade'
        run: |
          echo "======================================================================"
          echo "‚úÖ Istio Service Mesh Installed Successfully!"
          echo "======================================================================"
          echo ""
          echo "‚ö†Ô∏è  IMPORTANT: Manual steps required to complete setup:"
          echo ""
          echo "1Ô∏è‚É£  Restart pods to inject sidecars:"
          echo "    kubectl rollout restart deployment/dx03-backend -n dx03-dev"
          echo "    kubectl rollout restart deployment/dx03-frontend -n dx03-dev"
          echo ""
          echo "2Ô∏è‚É£  Wait for pods to be ready:"
          echo "    kubectl rollout status deployment/dx03-backend -n dx03-dev"
          echo "    kubectl rollout status deployment/dx03-frontend -n dx03-dev"
          echo ""
          echo "3Ô∏è‚É£  Apply Istio configurations:"
          echo "    kubectl apply -f k8s/istio/gateway.yaml"
          echo "    kubectl apply -f k8s/istio/telemetry.yaml"
          echo "    kubectl apply -f k8s/istio/security.yaml"
          echo ""
          echo "4Ô∏è‚É£  Verify installation:"
          echo "    kubectl get pods -n dx03-dev"
          echo "    kubectl get pods -n istio-system"
          echo "    istioctl proxy-status"
          echo ""
          echo "======================================================================"

      - name: üìä Display Istio Status
        if: inputs.action == 'install' || inputs.action == 'upgrade'
        run: |
          echo "============================================="
          echo "üéØ Istio Service Mesh Status"
          echo "============================================="
          echo ""
          
          echo "=== Istio Version ==="
          istioctl version
          echo ""
          
          echo "=== Istio Components ==="
          kubectl get pods -n istio-system
          echo ""
          
          echo "=== Sidecar Injection Status ==="
          kubectl get namespace -L istio-injection
          echo ""
          
          echo "=== Application Pods (with sidecars) ==="
          kubectl get pods -n dx03-dev -o wide
          echo ""
          
          echo "=== Istio Proxy Status ==="
          istioctl proxy-status
          echo ""
          
          echo "============================================="
          echo "‚úÖ Istio Service Mesh Ready!"
          echo "============================================="
          echo ""
          
          echo "üìö Next steps:"
          echo "1. Access Kiali dashboard:"
          echo "   kubectl port-forward -n istio-system svc/kiali 20001:20001"
          echo "   http://localhost:20001"
          echo ""
          echo "2. Access Jaeger tracing:"
          echo "   kubectl port-forward -n istio-system svc/jaeger 16686:16686"
          echo "   http://localhost:16686"
          echo ""
          echo "3. View service mesh topology in Kiali"
          echo "4. Monitor traffic metrics and traces"

      - name: üì§ Send Slack notification on success
        if: success() && (inputs.action == 'install' || inputs.action == 'upgrade')
        uses: slackapi/slack-github-action@v1.24.0
        continue-on-error: true
        with:
          payload: |
            {
              "text": "‚úÖ Istio Service Mesh ${{ inputs.action }} - Success",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚úÖ *Istio Service Mesh ${{ inputs.action }} Successful*\n\n*Profile:* ${{ inputs.profile }}\n*Version:* ${{ env.ISTIO_VERSION }}\n*Cluster:* ${{ env.CLUSTER_NAME }}\n\n*Features Enabled:*\nüîê mTLS automatic encryption\nüìä Traffic telemetry\nüîç Distributed tracing (Jaeger)\nüìà Service metrics (Prometheus)\nüó∫Ô∏è Service mesh visualization (Kiali)\n\n*Next Steps:*\n‚Ä¢ Access Kiali: `kubectl port-forward -n istio-system svc/kiali 20001:20001`\n‚Ä¢ Access Jaeger: `kubectl port-forward -n istio-system svc/jaeger 16686:16686`"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: üì§ Send Slack notification on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        continue-on-error: true
        with:
          payload: |
            {
              "text": "‚ùå Istio Service Mesh ${{ inputs.action }} - Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚ùå *Istio Service Mesh ${{ inputs.action }} Failed*\n\nCheck the GitHub Actions logs for details."
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
