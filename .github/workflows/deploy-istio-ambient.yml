name: üîß Deploy Istio Ambient Mesh

on:
  workflow_dispatch:
    inputs:
      mesh_type:
        description: 'Service Mesh Type'
        required: true
        type: choice
        options:
          - asm
          - ambient
        default: asm
      
      enable_namespace:
        description: 'Enable service mesh for dx03-dev namespace'
        required: true
        type: boolean
        default: true
      
      deploy_waypoint:
        description: 'Deploy waypoint proxies (L7 features - Ambient only)'
        required: true
        type: boolean
        default: false
      
      apply_policies:
        description: 'Apply authorization policies'
        required: true
        type: boolean
        default: true

env:
  GCP_REGION: us-central1
  CLUSTER_NAME: tx03-gke-cluster
  NAMESPACE: dx03-dev
  ISTIO_VERSION: "1.20.1"
  GCP_PROJECT_ID: tx03-444615
  ASM_VERSION: "1.20"

jobs:
  deploy-ambient-mesh:
    name: Deploy Istio Ambient Mesh
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: üîë Checkout code
        uses: actions/checkout@v4

      - name: üîê Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          token_format: 'access_token'

      - name: ‚òÅÔ∏è Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'gke-gcloud-auth-plugin'

      - name: üîß Configure kubectl
        run: |
          gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} \
            --region=${{ env.GCP_REGION }}
          
          kubectl version --client
          kubectl cluster-info

      - name: üì¶ Install istioctl
        if: ${{ inputs.mesh_type == 'ambient' }}
        run: |
          echo "üì¶ Downloading Istio ${{ env.ISTIO_VERSION }}..."
          curl -L https://istio.io/downloadIstio | ISTIO_VERSION=${{ env.ISTIO_VERSION }} sh -
          cd istio-${{ env.ISTIO_VERSION }}
          export PATH=$PWD/bin:$PATH
          
          echo "‚úÖ istioctl version:"
          istioctl version --remote=false
          
          # Add to PATH for subsequent steps
          echo "$PWD/bin" >> $GITHUB_PATH

      - name: üì¶ Download ASM CLI
        if: ${{ inputs.mesh_type == 'asm' }}
        run: |
          echo "üì¶ Downloading ASM CLI..."
          curl -L https://storage.googleapis.com/csm-artifacts/asm/asmcli_${{ env.ASM_VERSION }} -o asmcli
          chmod +x asmcli
          
          echo "‚úÖ ASM CLI downloaded"
          ./asmcli version || echo "Version command not available"

      - name: üîß Install Istio Ambient Profile
        if: ${{ inputs.mesh_type == 'ambient' }}
        run: |
          echo "üîß Installing Istio with Ambient profile..."
          
          istioctl install --set profile=ambient \
            --set values.global.istioNamespace=istio-system \
            --set values.global.proxy.privileged=false \
            --skip-confirmation
          
          echo "‚è≥ Waiting for Istio components..."
          kubectl wait --for=condition=ready pod \
            -l app=istiod \
            -n istio-system \
            --timeout=300s
          
          kubectl wait --for=condition=ready pod \
            -l app=ztunnel \
            -n istio-system \
            --timeout=300s || echo "‚ö†Ô∏è ztunnel pods may still be initializing"
          
          echo "‚úÖ Istio Ambient installation complete!"

      - name: üîß Install ASM (Anthos Service Mesh)
        if: ${{ inputs.mesh_type == 'asm' }}
        run: |
          echo "üîß Installing ASM (Anthos Service Mesh)..."
          
          # Register cluster to fleet (if not already)
          echo "üö¢ Registering cluster to fleet..."
          gcloud container fleet memberships register ${{ env.CLUSTER_NAME }} \
            --gke-cluster=${{ env.GCP_REGION }}/${{ env.CLUSTER_NAME }} \
            --enable-workload-identity \
            --project=${{ env.GCP_PROJECT_ID }} 2>&1 | tee /tmp/fleet-register.log || echo "‚ÑπÔ∏è Cluster may already be registered"
          
          # Check if registration was successful or already exists
          if gcloud container fleet memberships describe ${{ env.CLUSTER_NAME }} --project=${{ env.GCP_PROJECT_ID }} > /dev/null 2>&1; then
            echo "‚úÖ Cluster registered in fleet"
          else
            echo "‚ö†Ô∏è Fleet registration issue, continuing..."
          fi
          
          # Validate prerequisites
          echo "‚úÖ Validating ASM prerequisites..."
          ./asmcli validate \
            --project_id ${{ env.GCP_PROJECT_ID }} \
            --cluster_name ${{ env.CLUSTER_NAME }} \
            --cluster_location ${{ env.GCP_REGION }} \
            --fleet_id ${{ env.GCP_PROJECT_ID }} \
            --output_dir ./asm-validation 2>&1 | tee /tmp/asm-validate.log || echo "‚ö†Ô∏è Validation warnings (proceeding anyway)"
          
          # Install ASM
          echo "üöÄ Installing ASM..."
          ./asmcli install \
            --project_id ${{ env.GCP_PROJECT_ID }} \
            --cluster_name ${{ env.CLUSTER_NAME }} \
            --cluster_location ${{ env.GCP_REGION }} \
            --fleet_id ${{ env.GCP_PROJECT_ID }} \
            --output_dir ./asm-output \
            --enable_all \
            --ca mesh_ca \
            --option legacy-default-ingressgateway \
            --verbose 2>&1 | tee /tmp/asm-install.log
          
          ASM_EXIT_CODE=$?
          
          if [ $ASM_EXIT_CODE -eq 0 ]; then
            echo "‚úÖ ASM installation complete!"
          else
            echo "‚ùå ASM installation failed with exit code $ASM_EXIT_CODE"
            echo "üìã Last 50 lines of installation log:"
            tail -50 /tmp/asm-install.log
            exit $ASM_EXIT_CODE
          fi

      - name: üìä Check Istio Status
        run: |
          echo "üìä Istio Components Status:"
          kubectl get pods -n istio-system
          
          echo ""
          echo "üîç ztunnel DaemonSet:"
          kubectl get daemonset -n istio-system ztunnel || echo "‚ö†Ô∏è ztunnel not found (will be created by profile)"
          
          echo ""
          echo "üéØ Istiod Deployment:"
          kubectl get deployment -n istio-system istiod

      - name: üè∑Ô∏è Enable Service Mesh for Namespace
        if: ${{ inputs.enable_namespace }}
        run: |
          echo "üè∑Ô∏è Enabling service mesh for namespace: ${{ env.NAMESPACE }}"
          
          # Remove old labels
          kubectl label namespace ${{ env.NAMESPACE }} istio-injection- || true
          kubectl label namespace ${{ env.NAMESPACE }} istio.io/dataplane-mode- || true
          
          # Apply appropriate label based on mesh type
          if [ "${{ inputs.mesh_type }}" == "asm" ]; then
            echo "üìù Applying ASM sidecar injection label..."
            
            # Get ASM revision label
            ASM_REVISION=$(kubectl get deploy -n istio-system -l app=istiod -o jsonpath='{.items[0].metadata.labels.istio\.io/rev}' 2>/dev/null || echo "asm-managed")
            
            echo "Using ASM revision: $ASM_REVISION"
            kubectl label namespace ${{ env.NAMESPACE }} istio.io/rev=$ASM_REVISION --overwrite
          else
            echo "üìù Applying Ambient mesh label..."
            kubectl label namespace ${{ env.NAMESPACE }} istio.io/dataplane-mode=ambient --overwrite
          fi
          
          echo "‚úÖ Namespace labels:"
          kubectl get namespace ${{ env.NAMESPACE }} --show-labels

      - name: üîÑ Restart Application Pods
        if: ${{ inputs.enable_namespace }}
        run: |
          echo "üîÑ Restarting application deployments..."
          
          kubectl rollout restart deployment/dx03-backend -n ${{ env.NAMESPACE }}
          kubectl rollout restart deployment/dx03-frontend -n ${{ env.NAMESPACE }}
          
          echo "‚è≥ Waiting for rollout..."
          kubectl rollout status deployment/dx03-backend -n ${{ env.NAMESPACE }} --timeout=300s
          kubectl rollout status deployment/dx03-frontend -n ${{ env.NAMESPACE }} --timeout=300s
          
          echo "‚úÖ Pods restarted successfully!"

      - name: üåê Deploy Waypoint Proxies
        if: ${{ inputs.deploy_waypoint && inputs.mesh_type == 'ambient' }}
        run: |
          echo "üåê Deploying waypoint proxies for L7 features..."
          
          kubectl apply -f k8s/istio/ambient-mesh/waypoint-proxies.yaml
          
          echo "‚è≥ Waiting for waypoint proxies..."
          sleep 10
          
          echo "üìä Waypoint proxy status:"
          kubectl get gateway -n ${{ env.NAMESPACE }}

      - name: üîê Apply Authorization Policies
        if: ${{ inputs.apply_policies }}
        run: |
          echo "üîê Applying authorization policies..."
          
          kubectl apply -f k8s/istio/ambient-mesh/authorization-policies.yaml
          
          echo "‚úÖ Policies applied:"
          kubectl get peerauthentication,authorizationpolicy -n ${{ env.NAMESPACE }}

      - name: üìà Apply Telemetry Configuration
        if: ${{ inputs.apply_policies }}
        run: |
          echo "üìà Applying telemetry configuration..."
          
          kubectl apply -f k8s/istio/ambient-mesh/telemetry.yaml
          
          echo "‚úÖ Telemetry configured:"
          kubectl get telemetry -n ${{ env.NAMESPACE }}

      - name: ‚úÖ Validate Service Mesh
        run: |
          echo "‚úÖ Validating Service Mesh setup..."
          
          echo ""
          echo "üìä Namespace configuration:"
          kubectl get namespace ${{ env.NAMESPACE }} -o yaml | grep -A 5 labels
          
          echo ""
          echo "üîç Application pods:"
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide
          
          if [ "${{ inputs.mesh_type }}" == "asm" ]; then
            echo ""
            echo "üåê ASM Control Plane:"
            kubectl get pods -n istio-system -l app=istiod
            
            echo ""
            echo "üìä Pods should show 2/2 containers (app + istio-proxy sidecar)"
          else
            echo ""
            echo "üåê ztunnel DaemonSet status:"
            kubectl get daemonset -n istio-system ztunnel || echo "‚ö†Ô∏è ztunnel not found"
            
            echo ""
            echo "üìä Pods should show 1/1 containers (no sidecar in ambient mode)"
          fi
          
          echo ""
          echo "üéØ Services in mesh:"
          kubectl get services -n ${{ env.NAMESPACE }}

      - name: üìã Generate Summary
        run: |
          echo "## üîß Service Mesh Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.mesh_type }}" == "asm" ]; then
            echo "‚úÖ **Mesh Type**: Anthos Service Mesh (ASM)" >> $GITHUB_STEP_SUMMARY
            echo "üí∞ **Cost**: ~\$4-8/month (\$0.50 per vCPU)" >> $GITHUB_STEP_SUMMARY
            echo "üîß **Sidecars**: 2/2 containers (app + istio-proxy)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **Mesh Type**: Istio Ambient Mesh" >> $GITHUB_STEP_SUMMARY
            echo "üí∞ **Cost**: \$0 (Free)" >> $GITHUB_STEP_SUMMARY
            echo "üîß **Sidecars**: 1/1 containers (no sidecar)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ inputs.enable_namespace }}" == "true" ]; then
            echo "‚úÖ **Namespace Enrollment**: Enabled for ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ inputs.deploy_waypoint }}" == "true" ]; then
            echo "‚úÖ **Waypoint Proxies**: Deployed (L7 features active)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ inputs.apply_policies }}" == "true" ]; then
            echo "‚úÖ **Policies**: Applied (mTLS + AuthZ + Telemetry)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Current Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ env.NAMESPACE }} >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: üì£ Send Slack notification on success
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚úÖ Service Mesh - Success",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚úÖ *Service Mesh Deployed Successfully*\n\nüîß Mesh Type: ${{ inputs.mesh_type }}\nüîó Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: üì£ Send Slack notification on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚ùå Service Mesh - Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚ùå *Service Mesh Deployment Failed*\n\nüîß Mesh Type: ${{ inputs.mesh_type }}\nüîó Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
