name: üîß Deploy Istio Ambient Mesh

on:
  workflow_dispatch:
    inputs:
      install_ambient:
        description: 'Install Istio with Ambient profile'
        required: true
        type: boolean
        default: false
      
      enable_namespace:
        description: 'Enable ambient mesh for dx03-dev namespace'
        required: true
        type: boolean
        default: true
      
      deploy_waypoint:
        description: 'Deploy waypoint proxies (L7 features)'
        required: true
        type: boolean
        default: false
      
      apply_policies:
        description: 'Apply authorization policies'
        required: true
        type: boolean
        default: true

env:
  GCP_REGION: us-central1
  CLUSTER_NAME: tx03-gke-cluster
  NAMESPACE: dx03-dev
  ISTIO_VERSION: "1.20.1"

jobs:
  deploy-ambient-mesh:
    name: Deploy Istio Ambient Mesh
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: üîë Checkout code
        uses: actions/checkout@v4

      - name: üîê Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          token_format: 'access_token'

      - name: ‚òÅÔ∏è Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'gke-gcloud-auth-plugin'

      - name: üîß Configure kubectl
        run: |
          gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} \
            --region=${{ env.GCP_REGION }}
          
          kubectl version --client
          kubectl cluster-info

      - name: üì¶ Install istioctl
        if: ${{ inputs.install_ambient }}
        run: |
          echo "üì¶ Downloading Istio ${{ env.ISTIO_VERSION }}..."
          curl -L https://istio.io/downloadIstio | ISTIO_VERSION=${{ env.ISTIO_VERSION }} sh -
          cd istio-${{ env.ISTIO_VERSION }}
          export PATH=$PWD/bin:$PATH
          
          echo "‚úÖ istioctl version:"
          istioctl version --remote=false
          
          # Add to PATH for subsequent steps
          echo "$PWD/bin" >> $GITHUB_PATH

      - name: üîß Install Istio Ambient Profile
        if: ${{ inputs.install_ambient }}
        run: |
          echo "üîß Installing Istio with Ambient profile..."
          
          istioctl install --set profile=ambient \
            --set values.global.istioNamespace=istio-system \
            --set values.global.proxy.privileged=false \
            --skip-confirmation
          
          echo "‚è≥ Waiting for Istio components..."
          kubectl wait --for=condition=ready pod \
            -l app=istiod \
            -n istio-system \
            --timeout=300s
          
          kubectl wait --for=condition=ready pod \
            -l app=ztunnel \
            -n istio-system \
            --timeout=300s || echo "‚ö†Ô∏è ztunnel pods may still be initializing"
          
          echo "‚úÖ Istio Ambient installation complete!"

      - name: üìä Check Istio Status
        run: |
          echo "üìä Istio Components Status:"
          kubectl get pods -n istio-system
          
          echo ""
          echo "üîç ztunnel DaemonSet:"
          kubectl get daemonset -n istio-system ztunnel || echo "‚ö†Ô∏è ztunnel not found (will be created by profile)"
          
          echo ""
          echo "üéØ Istiod Deployment:"
          kubectl get deployment -n istio-system istiod

      - name: üè∑Ô∏è Enable Ambient Mesh for Namespace
        if: ${{ inputs.enable_namespace }}
        run: |
          echo "üè∑Ô∏è Enabling ambient mesh for namespace: ${{ env.NAMESPACE }}"
          
          # Remove old sidecar injection label if exists
          kubectl label namespace ${{ env.NAMESPACE }} istio-injection- || true
          
          # Apply ambient mesh label
          kubectl label namespace ${{ env.NAMESPACE }} istio.io/dataplane-mode=ambient --overwrite
          
          echo "‚úÖ Namespace labels:"
          kubectl get namespace ${{ env.NAMESPACE }} --show-labels

      - name: üîÑ Restart Application Pods
        if: ${{ inputs.enable_namespace }}
        run: |
          echo "üîÑ Restarting application deployments..."
          
          kubectl rollout restart deployment/dx03-backend -n ${{ env.NAMESPACE }}
          kubectl rollout restart deployment/dx03-frontend -n ${{ env.NAMESPACE }}
          
          echo "‚è≥ Waiting for rollout..."
          kubectl rollout status deployment/dx03-backend -n ${{ env.NAMESPACE }} --timeout=300s
          kubectl rollout status deployment/dx03-frontend -n ${{ env.NAMESPACE }} --timeout=300s
          
          echo "‚úÖ Pods restarted successfully!"

      - name: üåê Deploy Waypoint Proxies
        if: ${{ inputs.deploy_waypoint }}
        run: |
          echo "üåê Deploying waypoint proxies for L7 features..."
          
          kubectl apply -f k8s/istio/ambient-mesh/waypoint-proxies.yaml
          
          echo "‚è≥ Waiting for waypoint proxies..."
          sleep 10
          
          echo "üìä Waypoint proxy status:"
          kubectl get gateway -n ${{ env.NAMESPACE }}

      - name: üîê Apply Authorization Policies
        if: ${{ inputs.apply_policies }}
        run: |
          echo "üîê Applying authorization policies..."
          
          kubectl apply -f k8s/istio/ambient-mesh/authorization-policies.yaml
          
          echo "‚úÖ Policies applied:"
          kubectl get peerauthentication,authorizationpolicy -n ${{ env.NAMESPACE }}

      - name: üìà Apply Telemetry Configuration
        if: ${{ inputs.apply_policies }}
        run: |
          echo "üìà Applying telemetry configuration..."
          
          kubectl apply -f k8s/istio/ambient-mesh/telemetry.yaml
          
          echo "‚úÖ Telemetry configured:"
          kubectl get telemetry -n ${{ env.NAMESPACE }}

      - name: ‚úÖ Validate Ambient Mesh
        run: |
          echo "‚úÖ Validating Ambient Mesh setup..."
          
          echo ""
          echo "üìä Namespace enrollment:"
          kubectl get namespace ${{ env.NAMESPACE }} -o jsonpath='{.metadata.labels.istio\.io/dataplane-mode}'
          
          echo ""
          echo "üîç Application pods (should be 1/1 containers):"
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide
          
          echo ""
          echo "üåê ztunnel DaemonSet status:"
          kubectl get daemonset -n istio-system ztunnel
          
          echo ""
          echo "üìä Workload entries (ambient enrollment):"
          kubectl get workloadentry -A || echo "‚ÑπÔ∏è No workload entries yet (normal for fresh installation)"
          
          echo ""
          echo "üéØ Services in ambient mesh:"
          kubectl get services -n ${{ env.NAMESPACE }}

      - name: üìã Generate Summary
        run: |
          echo "## üîß Istio Ambient Mesh Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.install_ambient }}" == "true" ]; then
            echo "‚úÖ **Istio Ambient Profile**: Installed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚è≠Ô∏è **Istio Installation**: Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ inputs.enable_namespace }}" == "true" ]; then
            echo "‚úÖ **Namespace Enrollment**: Enabled for ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ inputs.deploy_waypoint }}" == "true" ]; then
            echo "‚úÖ **Waypoint Proxies**: Deployed (L7 features active)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ÑπÔ∏è **Waypoint Proxies**: Not deployed (L4 only)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ inputs.apply_policies }}" == "true" ]; then
            echo "‚úÖ **Policies**: Applied (mTLS + AuthZ + Telemetry)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Current Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ env.NAMESPACE }} >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: üì£ Send Slack notification on success
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚úÖ Istio Ambient Mesh - Success",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚úÖ *Istio Ambient Mesh Deployed Successfully*\n\nüîó Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: üì£ Send Slack notification on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚ùå Istio Ambient Mesh - Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚ùå *Istio Ambient Mesh Deployment Failed*\n\nüîó Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
