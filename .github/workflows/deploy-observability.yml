name: üìä Deploy Observability Stack

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - install
          - uninstall
          - upgrade
        default: install
      slack_webhook:
        description: 'Slack Webhook URL (optional)'
        required: false
        type: string

permissions:
  id-token: write
  contents: read

env:
  GCP_REGION: us-central1
  CLUSTER_NAME: tx03-gke-cluster
  NAMESPACE: monitoring

jobs:
  deploy-observability:
    name: ${{ github.event.inputs.action }} Observability Stack
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üîê Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
        create_credentials_file: true
        export_environment_variables: true
    
    - name: ‚òÅÔ∏è Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: ‚ò∏Ô∏è Configure kubectl
      run: |
        gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} \
          --region ${{ env.GCP_REGION }} \
          --project ${{ secrets.GCP_PROJECT_ID }}
        
        echo "‚úÖ Kubectl configured"
        kubectl cluster-info
        kubectl get nodes
    
    - name: üéØ Setup Helm
      uses: azure/setup-helm@v4
      with:
        version: '3.13.0'
    
    - name: üì¶ Add Helm Repositories
      if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
      run: |
        echo "üì¶ Adding Helm repositories..."
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo update
        echo "‚úÖ Repositories added and updated"
    
    - name: üìÅ Create Monitoring Namespace
      if: github.event.inputs.action == 'install'
      run: |
        echo "üìÅ Creating monitoring namespace..."
        kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
        echo "‚úÖ Namespace ready"
    
    - name: üîê Validate Grafana Password Secret
      if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
      run: |
        echo "üîê Validating GRAFANA_PASSWORD secret..."
        
        if [ -z "${{ secrets.GRAFANA_PASSWORD }}" ]; then
          echo "‚ùå ERROR: GRAFANA_PASSWORD secret is not configured!"
          echo ""
          echo "üìù To configure it:"
          echo "   1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
          echo "   2. Click 'New repository secret'"
          echo "   3. Name: GRAFANA_PASSWORD"
          echo "   4. Value: <your-strong-password>"
          echo ""
          echo "‚ö†Ô∏è  Use a strong password for production environments!"
          exit 1
        fi
        
        PASSWORD_LENGTH=$(echo -n "${{ secrets.GRAFANA_PASSWORD }}" | wc -c)
        if [ $PASSWORD_LENGTH -lt 8 ]; then
          echo "‚ö†Ô∏è  WARNING: Password is too short (less than 8 characters)"
          echo "üìù Consider using a stronger password for production"
        fi
        
        echo "‚úÖ GRAFANA_PASSWORD secret is configured (length: $PASSWORD_LENGTH chars)"
        echo "üîí Password will be securely applied to Grafana deployment"
    
    - name: üîî Configure Alertmanager
      if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
      env:
        SLACK_WEBHOOK: ${{ github.event.inputs.slack_webhook || secrets.SLACK_WEBHOOK_URL || 'https://hooks.slack.com/services/PLACEHOLDER' }}
      run: |
        echo "üîî Configuring Alertmanager with Slack notifications..."
        
        # Create Alertmanager config from template
        sed "s|SLACK_WEBHOOK_URL_PLACEHOLDER|${SLACK_WEBHOOK}|g" \
          k8s/observability/alertmanager-config.yaml | \
          kubectl apply -f -
        
        echo "‚úÖ Alertmanager configuration created"
    
    - name: üìä Install/Upgrade kube-prometheus-stack
      if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
      run: |
        echo "üìä ${{ github.event.inputs.action }}ing kube-prometheus-stack..."
        
        helm upgrade --install kube-prometheus-stack \
          prometheus-community/kube-prometheus-stack \
          --namespace ${{ env.NAMESPACE }} \
          --values k8s/observability/prometheus-values.yaml \
          --set grafana.adminPassword="${{ secrets.GRAFANA_PASSWORD }}" \
          --set alertmanager.enabled=true \
          --set alertmanager.config.useExistingSecret=true \
          --set alertmanager.config.secretName=alertmanager-config \
          --timeout=10m \
          --wait
        
        echo "‚úÖ Helm chart ${{ github.event.inputs.action }}ed successfully"
    
    - name: üìà Deploy ServiceMonitors
      if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
      run: |
        echo "üìà Deploying ServiceMonitors for DX03..."
        kubectl apply -f k8s/observability/servicemonitor.yaml
        echo "‚úÖ ServiceMonitors deployed"
    
    - name: üìä Deploy Grafana Dashboard
      if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
      run: |
        echo "üìä Deploying Grafana Dashboard..."
        kubectl apply -f k8s/observability/grafana-dashboard.yaml
        echo "‚úÖ Dashboard deployed"
    
    - name: ‚è≥ Wait for pods to be ready
      if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
      run: |
        echo "‚è≥ Waiting for Prometheus Operator..."
        kubectl wait --for=condition=ready pod \
          -l app.kubernetes.io/name=prometheus-operator \
          -n ${{ env.NAMESPACE }} \
          --timeout=300s || true
        
        echo "‚è≥ Waiting for Prometheus..."
        kubectl wait --for=condition=ready pod \
          -l app.kubernetes.io/name=prometheus \
          -n ${{ env.NAMESPACE }} \
          --timeout=300s || true
        
        echo "‚è≥ Waiting for Grafana..."
        kubectl wait --for=condition=ready pod \
          -l app.kubernetes.io/name=grafana \
          -n ${{ env.NAMESPACE }} \
          --timeout=300s || true
        
        echo "‚è≥ Waiting for Alertmanager..."
        kubectl wait --for=condition=ready pod \
          -l app.kubernetes.io/name=alertmanager \
          -n ${{ env.NAMESPACE }} \
          --timeout=300s || true
        
        echo "‚úÖ All pods are ready!"
    
    - name: üìä Get deployment status
      if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
      run: |
        echo "========================================"
        echo "üìä Observability Stack Status"
        echo "========================================"
        echo ""
        
        echo "=== Pods ==="
        kubectl get pods -n ${{ env.NAMESPACE }} -o wide
        
        echo ""
        echo "=== Services ==="
        kubectl get svc -n ${{ env.NAMESPACE }}
        
        echo ""
        echo "=== PersistentVolumeClaims ==="
        kubectl get pvc -n ${{ env.NAMESPACE }}
        
        echo ""
        echo "=== ServiceMonitors ==="
        kubectl get servicemonitor -n ${{ env.NAMESPACE }}
    
    - name: üìù Display access instructions
      if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
      run: |
        echo "========================================"
        echo "‚úÖ Observability Stack Deployed!"
        echo "========================================"
        echo ""
        echo "üìä Access Grafana:"
        echo "  kubectl port-forward -n ${{ env.NAMESPACE }} svc/kube-prometheus-stack-grafana 8080:80"
        echo "  http://localhost:8080"
        echo ""
        echo "üîë Credentials:"
        echo "    Username: admin"
        echo "    Password: (stored in GRAFANA_PASSWORD secret)"
        echo ""
        echo "üìà Access Prometheus:"
        echo "  kubectl port-forward -n ${{ env.NAMESPACE }} svc/kube-prometheus-stack-prometheus 9090:9090"
        echo "  http://localhost:9090"
        echo ""
        echo "üîî Access Alertmanager:"
        echo "  kubectl port-forward -n ${{ env.NAMESPACE }} svc/kube-prometheus-stack-alertmanager 9093:9093"
        echo "  http://localhost:9093"
        echo ""
        echo "üìö Pre-installed Dashboards:"
        echo "  - DX03 Application Dashboard"
        echo "  - Kubernetes Cluster Monitoring"
        echo "  - Node Exporter Full"
        echo "  - Prometheus Stats"
        echo ""
        echo "üîç Explore targets in Prometheus:"
        echo "  http://localhost:9090/targets"
        echo ""
    
    - name: üóëÔ∏è Uninstall observability stack
      if: github.event.inputs.action == 'uninstall'
      run: |
        echo "üóëÔ∏è Uninstalling observability stack..."
        
        # Delete ServiceMonitors
        kubectl delete -f k8s/observability/servicemonitor.yaml || true
        
        # Delete Grafana Dashboard
        kubectl delete -f k8s/observability/grafana-dashboard.yaml || true
        
        # Uninstall Helm chart
        helm uninstall kube-prometheus-stack -n ${{ env.NAMESPACE }} || true
        
        # Wait a bit for resources to be deleted
        sleep 10
        
        # Delete PVCs (optional - uncomment if you want to delete data)
        # kubectl delete pvc --all -n ${{ env.NAMESPACE }}
        
        # Delete namespace (this will remove everything)
        kubectl delete namespace ${{ env.NAMESPACE }} --wait=false || true
        
        echo "‚úÖ Observability stack uninstalled!"
        echo "‚ö†Ô∏è  PVCs were preserved. Delete manually if needed."
    
    - name: üì§ Send Slack notification on success
      if: success() && (github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade')
      env:
        SLACK_WEBHOOK: ${{ github.event.inputs.slack_webhook || secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [ -n "$SLACK_WEBHOOK" ] && [ "$SLACK_WEBHOOK" != "https://hooks.slack.com/services/PLACEHOLDER" ]; then
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "‚úÖ DX03 Observability Stack Deployed Successfully",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*DX03 Observability Stack Deployed*\n\nPrometheus, Grafana, and Alertmanager are now running on GKE."
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Cluster:*\ntx03-gke-cluster"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Namespace:*\nmonitoring"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Project:*\n${{ secrets.GCP_PROJECT_ID }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Action:*\n${{ github.event.inputs.action }}"
                    }
                  ]
                }
              ]
            }'
        fi
    
    - name: üì§ Send Slack notification on failure
      if: failure()
      env:
        SLACK_WEBHOOK: ${{ github.event.inputs.slack_webhook || secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [ -n "$SLACK_WEBHOOK" ] && [ "$SLACK_WEBHOOK" != "https://hooks.slack.com/services/PLACEHOLDER" ]; then
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "‚ùå DX03 Observability Stack Deployment Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*DX03 Observability Stack Deployment Failed*\n\nCheck the GitHub Actions logs for details."
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\n${{ github.workflow }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Action:*\n${{ github.event.inputs.action }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
                  }
                }
              ]
            }'
        fi
