name: "Apply Istio Configurations"

on:
  workflow_dispatch:
    inputs:
      restart_pods:
        description: 'Restart pods to inject sidecars'
        required: true
        default: 'true'
        type: boolean
      apply_configs:
        description: 'Apply Istio configurations (gateway, telemetry, security)'
        required: true
        default: 'true'
        type: boolean

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1
  CLUSTER_NAME: tx03-gke-cluster

jobs:
  apply-istio-configs:
    name: "Configure Istio Service Mesh"
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: ‚òÅÔ∏è Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: üîß Configure kubectl
        run: |
          gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: üîÑ Restart Pods for Sidecar Injection
        if: inputs.restart_pods == true
        run: |
          echo "üîÑ Restarting dx03 pods to inject Istio sidecars..."
          
          kubectl rollout restart deployment/dx03-backend -n dx03-dev
          kubectl rollout restart deployment/dx03-frontend -n dx03-dev
          
          echo "‚è≥ Pods are being restarted..."
          echo "Note: On GKE Autopilot, sidecar injection may take 10-15 minutes due to resource provisioning."
          echo "Check rollout status manually with:"
          echo "  kubectl rollout status deployment/dx03-backend -n dx03-dev"
          echo "  kubectl rollout status deployment/dx03-frontend -n dx03-dev"
          
          echo ""
          echo "‚úÖ Rollout initiated successfully"

      - name: üåê Apply Istio Configurations
        if: inputs.apply_configs == true
        run: |
          echo "üåê Applying Istio configurations..."
          
          if [ -f "k8s/istio/gateway.yaml" ]; then
            kubectl apply -f k8s/istio/gateway.yaml
            echo "‚úÖ Gateway configuration applied"
          fi
          
          if [ -f "k8s/istio/telemetry.yaml" ]; then
            kubectl apply -f k8s/istio/telemetry.yaml
            echo "‚úÖ Telemetry configuration applied"
          fi
          
          if [ -f "k8s/istio/security.yaml" ]; then
            kubectl apply -f k8s/istio/security.yaml
            echo "‚úÖ Security policies applied (PERMISSIVE mTLS)"
          fi
          
          echo ""
          echo "‚úÖ All Istio configurations applied!"

      - name: ‚úÖ Validate Installation
        run: |
          echo "======================================================================"
          echo "üéØ Istio Service Mesh Validation"
          echo "======================================================================"
          echo ""
          
          echo "=== Istio System Pods ==="
          kubectl get pods -n istio-system
          echo ""
          
          echo "=== Application Pods (should show 2/2 containers after sidecar injection) ==="
          kubectl get pods -n dx03-dev
          echo ""
          
          echo "=== Istio Gateway ==="
          kubectl get gateway -n dx03-dev
          echo ""
          
          echo "=== Istio VirtualService ==="
          kubectl get virtualservice -n dx03-dev
          echo ""
          
          echo "=== Istio DestinationRules ==="
          kubectl get destinationrule -n dx03-dev
          echo ""
          
          echo "======================================================================"
          echo "‚úÖ Istio Configuration Complete!"
          echo "======================================================================"
          echo ""
          echo "üìö Access Kiali dashboard:"
          echo "   kubectl port-forward -n istio-system svc/kiali 20001:20001"
          echo "   http://localhost:20001"
          echo ""
          echo "üìä Access Jaeger tracing:"
          echo "   kubectl port-forward -n istio-system svc/jaeger 16686:16686"
          echo "   http://localhost:16686"

      - name: üì§ Send Slack notification on success
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        continue-on-error: true
        with:
          payload: |
            {
              "text": "‚úÖ Istio Configurations Applied Successfully",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚úÖ *Istio Service Mesh Configured*\n\n*Restart Pods:* ${{ inputs.restart_pods }}\n*Apply Configs:* ${{ inputs.apply_configs }}\n\n*Next:* Access Kiali dashboard to view service mesh\n`kubectl port-forward -n istio-system svc/kiali 20001:20001`"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: üì§ Send Slack notification on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        continue-on-error: true
        with:
          payload: |
            {
              "text": "‚ùå Istio Configuration Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚ùå *Istio Configuration Failed*\n\nCheck workflow logs for details."
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
