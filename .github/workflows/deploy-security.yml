name: ğŸ” Deploy Security Stack

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - install
          - uninstall
          - upgrade
        default: install

permissions:
  id-token: write
  contents: read

env:
  GCP_REGION: us-central1
  CLUSTER_NAME: tx03-gke-cluster
  GATEKEEPER_NAMESPACE: gatekeeper-system
  TRIVY_NAMESPACE: trivy-system

jobs:
  deploy-security:
    name: ${{ github.event.inputs.action }} Security Stack
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
        create_credentials_file: true
        export_environment_variables: true
    
    - name: â˜ï¸ Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: ğŸ”Œ Install GKE Auth Plugin
      run: |
        echo "ğŸ”Œ Installing gke-gcloud-auth-plugin..."
        gcloud components install gke-gcloud-auth-plugin --quiet
        echo "âœ… Plugin installed"
    
    - name: â˜¸ï¸ Configure kubectl
      run: |
        echo "âš™ï¸  Configuring kubectl for GKE..."
        gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} \
          --region ${{ env.GCP_REGION }} \
          --project ${{ secrets.GCP_PROJECT_ID }}
        
        echo "âœ… Kubectl configured"
        kubectl cluster-info

    - name: ğŸ¯ Setup Helm
      uses: azure/setup-helm@v4
      with:
        version: '3.13.0'
    
    - name: ğŸ“¦ Add Helm Repositories
      if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
      run: |
        echo "ğŸ“¦ Adding Helm repositories..."
        helm repo add gatekeeper https://open-policy-agent.github.io/gatekeeper/charts
        helm repo add aqua https://aquasecurity.github.io/helm-charts/
        helm repo update
        echo "âœ… Repositories added and updated"

    - name: ğŸ“ Create Namespaces
      if: github.event.inputs.action == 'install'
      run: |
        echo "ğŸ“ Creating security namespaces..."
        kubectl create namespace ${{ env.GATEKEEPER_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
        kubectl create namespace ${{ env.TRIVY_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
        
        # Label namespaces
        kubectl label namespace ${{ env.GATEKEEPER_NAMESPACE }} app=gatekeeper security=policy-as-code --overwrite
        kubectl label namespace ${{ env.TRIVY_NAMESPACE }} app=trivy-operator security=vulnerability-scanning --overwrite
        
        echo "âœ… Namespaces ready"

    - name: ğŸ” Install OPA Gatekeeper
      if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
      run: |
        echo "ğŸ” Installing/Upgrading OPA Gatekeeper..."
        
        helm upgrade --install gatekeeper gatekeeper/gatekeeper \
          --namespace ${{ env.GATEKEEPER_NAMESPACE }} \
          --values k8s/security/gatekeeper-values.yaml \
          --timeout=10m \
          --atomic=false
        
        echo "âœ… OPA Gatekeeper ${{ github.event.inputs.action }}ed"
        echo "â³ Waiting for Gatekeeper deployment..."
        
        kubectl wait --for=condition=ready pod \
          -l control-plane=controller-manager \
          -n ${{ env.GATEKEEPER_NAMESPACE }} \
          --timeout=300s || echo "âš ï¸  Gatekeeper deployment ongoing"

    - name: ğŸ“‹ Deploy Gatekeeper Policies
      if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
      run: |
        echo "ğŸ“‹ Deploying constraint templates and policies..."
        
        # Apply constraint templates
        kubectl apply -f k8s/security/gatekeeper-policies.yaml
        
        # Apply constraints
        kubectl apply -f k8s/security/gatekeeper-constraints.yaml
        
        echo "âœ… Gatekeeper policies deployed"
        
        # List constraints
        echo ""
        echo "ğŸ“Š Constraints deployed:"
        kubectl get constraints
        
        # Show violations
        echo ""
        echo "âš ï¸  Checking for violations..."
        kubectl get constraints -o json | jq -r '.items[] | "\(.kind): \(.metadata.name)"' || echo "No violations found"

    - name: ğŸ” Install Trivy Operator
      if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
      run: |
        echo "ğŸ” Installing/Upgrading Trivy Operator..."
        
        helm upgrade --install trivy-operator aqua/trivy-operator \
          --namespace ${{ env.TRIVY_NAMESPACE }} \
          --values k8s/security/trivy-operator-values.yaml \
          --timeout=10m \
          --atomic=false
        
        echo "âœ… Trivy Operator ${{ github.event.inputs.action }}ed"
        echo "â³ Waiting for Trivy deployment..."
        
        kubectl wait --for=condition=ready pod \
          -l app.kubernetes.io/name=trivy-operator \
          -n ${{ env.TRIVY_NAMESPACE }} \
          --timeout=300s || echo "âš ï¸  Trivy deployment ongoing"

    - name: âš™ï¸ Deploy Trivy Configuration
      if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
      run: |
        echo "âš™ï¸  Deploying Trivy configuration..."
        
        kubectl apply -f k8s/security/trivy-operator-config.yaml
        
        echo "âœ… Trivy configuration deployed"
        
        # Show config
        echo ""
        echo "ğŸ“Š Trivy ConfigMap:"
        kubectl get cm trivy-operator-config -n ${{ env.TRIVY_NAMESPACE }} -o yaml

    - name: â³ Wait for Pods
      if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
      run: |
        echo "â³ Waiting for security stack pods..."
        
        echo "ğŸ” Gatekeeper pods:"
        kubectl get pods -n ${{ env.GATEKEEPER_NAMESPACE }} -o wide
        
        echo ""
        echo "ğŸ” Trivy pods:"
        kubectl get pods -n ${{ env.TRIVY_NAMESPACE }} -o wide
        
        echo ""
        echo "âœ… Security stack deployed!"

    - name: ğŸ“Š Display Security Stack Status
      if: github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade'
      run: |
        echo "=========================================="
        echo "ğŸ” Security Stack Status"
        echo "=========================================="
        echo ""
        
        echo "=== OPA Gatekeeper ==="
        kubectl get deployment -n ${{ env.GATEKEEPER_NAMESPACE }} -o wide || echo "No Gatekeeper deployment found"
        
        echo ""
        echo "Constraints:"
        kubectl get constraints || echo "No constraints deployed"
        
        echo ""
        echo "=== Trivy Operator ==="
        kubectl get deployment -n ${{ env.TRIVY_NAMESPACE }} -o wide || echo "No Trivy deployment found"
        
        echo ""
        echo "Trivy CRDs:"
        kubectl api-resources | grep -i trivy || echo "No Trivy CRDs found"
        
        echo ""
        echo "=========================================="
        echo "âœ… Security Stack Ready!"
        echo "=========================================="
        echo ""
        echo "ğŸ“š Next steps:"
        echo "1. Monitor Gatekeeper violations:"
        echo "   kubectl describe constraint required-resources"
        echo ""
        echo "2. Check Trivy scan results:"
        echo "   kubectl get vulnerabilityreports -n dx03-dev"
        echo ""
        echo "3. View detailed reports:"
        echo "   kubectl describe vr <report-name> -n dx03-dev"

    - name: ğŸ—‘ï¸ Uninstall Security Stack
      if: github.event.inputs.action == 'uninstall'
      run: |
        echo "ğŸ—‘ï¸  Uninstalling security stack..."
        
        # Uninstall Helm charts
        echo "Removing Trivy Operator..."
        helm uninstall trivy-operator -n ${{ env.TRIVY_NAMESPACE }} 2>/dev/null || echo "Trivy already removed"
        
        echo "Removing OPA Gatekeeper..."
        helm uninstall gatekeeper -n ${{ env.GATEKEEPER_NAMESPACE }} 2>/dev/null || echo "Gatekeeper already removed"
        
        # Delete namespaces (optional)
        echo "Deleting namespaces..."
        kubectl delete namespace ${{ env.GATEKEEPER_NAMESPACE }} --ignore-not-found=true
        kubectl delete namespace ${{ env.TRIVY_NAMESPACE }} --ignore-not-found=true
        
        echo "âœ… Security stack uninstalled"

    - name: ğŸ“¤ Send Slack notification on success
      if: success() && (github.event.inputs.action == 'install' || github.event.inputs.action == 'upgrade')
      uses: slackapi/slack-github-action@v1.24.0
      with:
        webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
        payload: |
          {
            "text": "âœ… Security Stack ${{ github.event.inputs.action }} - Success",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "âœ… *Security Stack ${{ github.event.inputs.action }} Successful*\n\n*Components:*\nğŸ” OPA Gatekeeper - Policy enforcement\nğŸ” Trivy Operator - Vulnerability scanning\n\n*Next Steps:*\nâ€¢ Monitor violations: `kubectl describe constraint required-resources`\nâ€¢ Check scan reports: `kubectl get vulnerabilityreports -n dx03-dev`"
                }
              }
            ]
          }
      continue-on-error: true

    - name: ğŸ“¤ Send Slack notification on failure
      if: failure()
      uses: slackapi/slack-github-action@v1.24.0
      with:
        webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
        payload: |
          {
            "text": "âŒ Security Stack ${{ github.event.inputs.action }} - Failed",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "âŒ *Security Stack ${{ github.event.inputs.action }} Failed*\n\nğŸ”— Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }
              }
            ]
          }
      continue-on-error: true
